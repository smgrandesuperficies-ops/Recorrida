<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAGRADA MADRE - Movimientos de Planta — Sistema interno</title>
  <style>
    :root{
      --bg: #edf2f7;
      --card: #ffffff;
      --primary: #2563eb;
      --text: #0f172a;
      --muted: #6b7280;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);transition:background .3s ease}
    header{background:linear-gradient(90deg,#2563eb,#1d4ed8);color:white;padding:14px 16px;border-radius:14px;max-width:1100px;margin:0 auto 8px}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(15,23,42,0.08);margin-top:12px}
    label{display:block;margin-top:8px;font-size:13px;color:#334155}
    input[type=text],input[type=password],input[type=datetime-local],select,textarea{
      width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:6px;background:#f8fafc
    }
    button{background:var(--primary);color:white;border:0;padding:8px 12px;border-radius:999px;font-weight:600;margin-top:10px;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #e2e8f0;border-radius:999px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row .col{flex:1;min-width:160px}
    .movement{position:relative;padding:10px;border:1px solid #e6eef8;border-radius:8px;margin-bottom:8px;background:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
    .estado-Pendiente{background:#fee4e2;color:#b42318}
    .estado-Listo\ para\ retirar{background:#fef9c3;color:#854d0e}
    .estado-En\ viaje{background:#eff8ff;color:#175cd3}
    .estado-Entregado{background:#ecfdf3;color:#027a48}
    .estado-Faltante{background:#fee2e2;color:#b91c1c}
    small{color:var(--muted)}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .delete-x{
      position:absolute;top:6px;right:6px;
      background:#f97316;color:white;border:none;border-radius:999px;
      width:26px;height:26px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:bold
    }
    .filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .filter-active{background:#0f172a;color:white;border-color:transparent}
    @media(min-width:900px){
      .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
      body{max-width:1100px;margin:0 auto;}
      .full-width{grid-column:1 / -1;}
    }
    #app{display:none}
    #rolePicker{display:none}

    /* colores por rol */
    body.role-encargado { --primary:#0f766e; --bg:#e0f2f1; }
    body.role-preparado { --primary:#16a34a; --bg:#e8f6ec; }
    body.role-fletero   { --primary:#f97316; --bg:#fff1e8; }
    body.role-admin     { --primary:#0f172a; --bg:#e5e7eb; }
    body.role-logistica { --primary:#7c3aed; --bg:#ede9fe; }

    /* COBRANZAS (nuevo estilo) */
    body.role-cobranzas {
      --primary:#ec4899;       /* Rosa fuerte */
      --bg:#fdf2f8;            /* Fondo rosa clarito */
      font-family:"Trebuchet MS", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* Fletero de cobranzas */
    body.role-fletero_cob {
      --primary:#b91c1c;       /* Rojo oscuro */
      --bg:#fee2e2;            /* Fondo rojo claro */
    }

    /* headers por rol */
    body.role-preparado header{background:linear-gradient(90deg,#16a34a,#15803d);}
    body.role-fletero header{background:linear-gradient(90deg,#f97316,#ea580c);}
    body.role-admin header{background:linear-gradient(90deg,#0f172a,#1f2937);}
    body.role-logistica header{background:linear-gradient(90deg,#7c3aed,#6d28d9);}
    body.role-cobranzas header{background:linear-gradient(90deg,#ec4899,#db2777);}
    body.role-fletero_cob header{background:linear-gradient(90deg,#b91c1c,#dc2626);}

    /* Rol "cobranzas" en rosa más grande */
    body.role-cobranzas #userRole{
      color:#ec4899;
      font-size:15px;
      font-weight:700;
    }

    .admin-table{width:100%;border-collapse:collapse;margin-top:6px}
    .admin-table th,.admin-table td{border:1px solid #e2e8f0;padding:6px;font-size:13px;text-align:left}
    .date-title{font-size:13px;font-weight:600;margin-top:10px;margin-bottom:4px;color:#0f172a}
    .admin-mov-list{max-height:260px;overflow-y:auto;margin-top:6px;border:1px solid #e2e8f0;border-radius:8px;padding:6px}
    .admin-mov-item{font-size:12px;border-bottom:1px solid #eef2f6;padding:4px 0}
    .admin-mov-item:last-child{border-bottom:0}

    /* picker de color fletero */
    #fleteroColorBox{margin-top:10px;display:none}
    .color-pill{
      width:28px;height:28px;border-radius:999px;border:2px solid transparent;cursor:pointer;display:inline-block;margin-right:6px;
    }
    .color-pill.selected{border-color:#0f172a}

    /* lista recorridas */
    .recorridas-list small{display:block;margin-top:2px}
  </style>
</head>
<body>
<header>
  <h1>Movimientos de Planta — Sistema interno</h1>
</header>
<!-- GIF con fondo transparente -->
<div id="loginGifContainer"
     style="display:flex;justify-content:center;align-items:center;width:100%;margin-top:35px;margin-bottom:10px;">
  <img src="20-PM-unscreen.gif" alt="Camión animado" 
       style="width:280px;max-width:90%;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.1));">
</div>
  
<!-- LOGIN -->
<div class="card" id="loginBox">
  <h2 style="margin-top:0;font-size:15px">Ingresar</h2>
  <label>Correo
    <input id="loginEmail" type="text" placeholder="encargado@empresa.com" />
  </label>
  <label>Contraseña
    <input id="loginPass" type="password" placeholder="******" />
  </label>
  <button id="btnLogin">Ingresar</button>
  <button id="btnRegister" class="ghost">Crear cuenta</button>
  <small style="display:block;margin-top:6px">
    Encargados, Preparado, Fleteros, Logística, Cobranzas, Fletero Cobranzas y Admin se loguean acá.
  </small>
</div>

<!-- ELEGIR ROL / FLETERO COLOR -->
<div class="card" id="rolePicker">
  <h2 style="margin-top:0;font-size:15px">Seleccioná tu rol</h2>
  <p style="margin:0 0 6px 0">No encontramos tu rol en el sistema. Elegí uno:</p>
  <div class="row">
    <div class="col"><button onclick="saveRole('encargado')">Soy ENCARGADO</button></div>
    <div class="col"><button onclick="saveRole('preparado')">Soy PREPARADO</button></div>
    <div class="col"><button onclick="chooseFletero()">Soy FLETERO</button></div>
    <div class="col"><button onclick="saveRole('logistica')">Soy LOGÍSTICA</button></div>
  </div>
  <div class="row" style="margin-top:6px">
    <div class="col"><button onclick="saveRole('cobranzas')">Soy COBRANZAS</button></div>
    <div class="col"><button onclick="saveRole('fletero_cob')">Soy FLETERO COBRANZAS</button></div>
  </div>

  <div id="fleteroColorBox" style="display:none;margin-top:10px">
    <small>Elegí tu color (solo una vez):</small>
    <div id="fleteroColorOptions" style="margin-top:6px"></div>
    <button id="btnConfirmFletero" style="margin-top:10px" onclick="confirmFletero()">Aceptar fletero</button>
  </div>

  <small>Esto se guarda una sola vez.</small>
</div>

<!-- APP -->
<div id="app">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px">
    <div>
      <strong id="userInfo"></strong>
      <small id="userRole" style="margin-left:4px"></small>
    </div>
    <button class="ghost" id="btnLogout">Salir</button>
  </div>

  <div class="grid-2">
    <!-- ENCARGADO -->
    <div class="card" id="encargadoBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Alta de movimiento (Encargado)</h2>
      <label>Nombre del encargado
        <input id="encargado" type="text" placeholder="Ej: Juan Pérez" />
      </label>
      <div class="row">
        <div class="col">
          <label>Planta / Origen
            <input id="origen" type="text" placeholder="Ej: Planta 1" />
          </label>
        </div>
        <div class="col">
          <label>Destino
            <input id="destino" type="text" placeholder="Ej: Depósito central" />
          </label>
        </div>
      </div>
      <label>Producto / Descripción
        <textarea id="descripcion" rows="3" placeholder="Una cosa por línea. Ej:
20 cajas palo santo
5 cajas sahumerios
3 bolsas carbón"></textarea>
      </label>
      <div class="row">
        <div class="col">
          <label>Prioridad
            <select id="prioridad">
              <option value="Media">Media</option>
              <option value="Alta">Alta</option>
              <option value="Baja">Baja</option>
            </select>
          </label>
        </div>
      </div>
      <label>Tipo de viaje
        <select id="tipoViaje">
          <option value="Materia Prima">Materia Prima</option>
          <option value="Productos Terminados">Productos Terminados</option>
          <option value="Otro">Otro</option>
        </select>
      </label>
      <label>Observaciones
        <textarea id="obs" rows="2" placeholder="Algo a tener en cuenta..."></textarea>
      </label>
      <button id="btnCreate">Crear movimiento</button>
      <small style="display:block;margin-top:6px">Se crea con estado <strong>Pendiente</strong>.</small>
    </div>

    <!-- PREPARADO -->
    <div class="card" id="preparadoBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel de preparado</h2>
      <small>Marcás los pedidos como “Listo para retirar”, podés poner horario estimado o reportar faltante.</small>
      <label>Horario estimado por defecto
        <input id="defaultHora" type="datetime-local" />
      </label>
    </div>

    <!-- FLETERO -->
    <div class="card" id="fleteroBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel del fletero</h2>
      <label>Mi nombre (fletero)
        <input id="fleteroNombre" type="text" placeholder="Ej: Camión 3 - Luis" />
      </label>
      <small>Tomá el pedido y actualizá el estado.</small>
    </div>

    <!-- LOGÍSTICA -->
    <div class="card" id="logisticaBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Logística – armar recorrida</h2>
      <small>Ingresá la dirección de origen y abajo una dirección por línea, en el orden que querés recorrer.</small>
      <label>Origen
        <input id="log-origen" type="text" placeholder="Ej: Planta, Calle 123, Ciudad" />
      </label>
      <label>Direcciones a entregar (una por línea, en orden)
        <textarea id="log-destinos" rows="5" placeholder="Cliente 1, dirección...
Cliente 2, dirección...
Cliente 3, dirección..."></textarea>
      </label>
      <button id="btnCalcularRecorrida">Generar link de Google Maps</button>
      <div id="log-result" style="margin-top:10px;font-size:13px"></div>
      <div class="recorridas-list" id="log-historial" style="margin-top:12px"></div>
    </div>

    <!-- COBRANZAS (full width) -->
    <div class="card full-width" id="cobranzasBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Cobranzas</h2>
      <h3 style="margin:4px 0;font-size:13px">Recorrida de cobranzas</h3>
      <small>Ingresá origen y las direcciones de cobranza (una por línea). El orden lo definís vos.</small>
      <label>Origen cobranzas
        <input id="cob-origen" type="text" placeholder="Ej: Planta o punto de partida" />
      </label>
      <label>Direcciones (una por línea, solo direcciones en orden de visita)
        <textarea id="cob-destinos" rows="4" placeholder="Dirección Cliente A...
Dirección Cliente B..."></textarea>
      </label>
      <button id="btnCobCalcularRecorrida">Generar link de Maps (Cobranza)</button>
      <div id="cob-recorrida-result" style="margin-top:8px;font-size:13px"></div>
      <div id="cob-historial" class="recorridas-list" style="margin-top:10px"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb">

      <h3 style="margin:4px 0;font-size:13px">Próximas recorridas</h3>
      <small>Agenda fechas futuras de cobranzas.</small>
      <label>Fecha
        <input id="cob-prox-fecha" type="date" />
      </label>
      <label>Detalle
        <textarea id="cob-prox-detalle" rows="2" placeholder="Ej: Zona norte, clientes grandes..."></textarea>
      </label>
      <button id="btnCobAgregarProx">Agregar próxima recorrida</button>
      <div id="cob-prox-list" style="margin-top:10px;font-size:13px"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb">

      <h3 style="margin:4px 0;font-size:13px">Clientes de cobranza</h3>
      <label>Cliente
        <input id="cob-cliente" type="text" placeholder="Nombre del cliente" />
      </label>
      <label>Dirección
        <input id="cob-direccion" type="text" placeholder="Dirección completa" />
      </label>
      <label>Observaciones
        <textarea id="cob-obs" rows="2" placeholder="Referencia de pago, ventana horaria, etc."></textarea>
      </label>
      <button id="btnCobAgregar">Agregar a la lista de cobranza</button>
      <div id="cob-mov-list" style="margin-top:10px;font-size:13px"></div>
      <small>El estado solo puede marcarlo el Fletero de cobranzas.</small>
    </div>

    <!-- FLETERO COBRANZAS -->
    <div class="card" id="fleteroCobBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Fletero de cobranzas</h2>
      <small>Ves la lista de clientes de cobranza y marcás cuando el dinero fue retirado.</small>
      <div id="cob-mov-list-fletero" style="margin-top:10px;font-size:13px"></div>
    </div>

    <!-- ADMIN -->
    <div class="card" id="adminBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel de administración</h2>
      <small>Solo gerencia@sagradamadre.com puede ver esto.</small>
      <div id="usersList"></div>
      <h3 style="margin-top:14px;font-size:13px">Registro completo de movimientos</h3>
      <small>Histórico (no se borra)</small>
      <div id="adminMovList" class="admin-mov-list"></div>
    </div>
  </div>

  <!-- LISTA MOVIMIENTOS PLANTA -->
  <div class="card" id="movimientosCard" style="margin-top:12px">
    <h2 style="margin:0 0 6px 0;font-size:15px">Movimientos registrados</h2>
    <div class="filter-bar">
      <button class="ghost filter-active" id="filter-todos">Todos</button>
      <button class="ghost" id="filter-mp">Materia Prima</button>
      <button class="ghost" id="filter-pt">Productos Terminados</button>
    </div>
    <div id="movList"></div>
    <small id="movCount"></small>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script>
  const ADMIN_EMAILS = ["gerencia@sagradamadre.com"];

  const firebaseConfig = {
    apiKey: "AIzaSyDREgLXzhcblLmAD8ROhdin29TwGjCkH7Q",
    authDomain: "recorrida-planta.firebaseapp.com",
    projectId: "recorrida-planta",
    storageBucket: "recorrida-planta.firebasestorage.app",
    messagingSenderId: "528466299629",
    appId: "1:528466299629:web:e1ebe7fab15d030d6e5ae4",
    measurementId: "G-XPV4W80QZ2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const $ = id => document.getElementById(id);
  const COL_MOV = "movimientos";
  const COL_USERS = "usuarios";
  const COL_RECORRIDAS = "recorridas";           // logística
  const COL_COB_MOV = "cob_movimientos";         // clientes cobranza
  const COL_COB_RECORRIDAS = "cob_recorridas";   // recorridas cobranza
  const COL_COB_PROX = "cob_proximas";           // próximas recorridas

  const FLETERO_COLORS = ["#f97316","#0ea5e9","#22c55e","#a855f7","#f43f5e","#eab308"];
  let selectedFleteroColor = null;

  let currentUser = null;
  let currentUserData = null;
  let currentRole = null;
  let currentTypeFilter = "todos";
  let unsubscribeMov = null;
  let unsubscribeUsers = null;
  let unsubscribeAdminMov = null;
  let unsubscribeRecorridas = null;
  let unsubscribeCobMov = null;
  let unsubscribeCobRec = null;
  let unsubscribeCobProx = null;

  // LOGIN
  $('btnLogin').onclick = async () => {
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value.trim();
    if(!email || !pass){ alert("Completá email y contraseña"); return; }
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch(e){ alert("Error al ingresar: " + e.message); }
  };

  // REGISTRO
  $('btnRegister').onclick = async () => {
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value.trim();
    if(!email || !pass){ alert("Completá email y contraseña"); return; }
    try { await auth.createUserWithEmailAndPassword(email, pass); }
    catch(e){ alert("Error al crear usuario: " + e.message); }
  };

  $('btnLogout').onclick = () => auth.signOut();

  // SESIÓN
  auth.onAuthStateChanged(async (user)=>{
    currentUser = user;
    currentUserData = null;
    if(!user){
      document.body.className = '';
      $('loginBox').style.display = 'block';
      $('app').style.display = 'none';
      $('rolePicker').style.display = 'none';
      if (unsubscribeMov) { unsubscribeMov(); unsubscribeMov = null; }
      if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
      if (unsubscribeAdminMov) { unsubscribeAdminMov(); unsubscribeAdminMov = null; }
      if (unsubscribeRecorridas) { unsubscribeRecorridas(); unsubscribeRecorridas = null; }
      if (unsubscribeCobMov) { unsubscribeCobMov(); unsubscribeCobMov = null; }
      if (unsubscribeCobRec) { unsubscribeCobRec(); unsubscribeCobRec = null; }
      if (unsubscribeCobProx) { unsubscribeCobProx(); unsubscribeCobProx = null; }
      return;
    }
    $('loginBox').style.display = 'none';
    $('userInfo').textContent = user.email;

    // admin fijo
    if (ADMIN_EMAILS.includes(user.email)) {
      await db.collection(COL_USERS).doc(user.uid).set({
        email: user.email,
        rol: 'admin',
        createdAt: new Date().toISOString()
      }, { merge: true });
    }

    const ref = db.collection(COL_USERS).doc(user.uid);
    const doc = await ref.get();
    if(!doc.exists){
      $('rolePicker').style.display = 'block';
      $('app').style.display = 'none';
      return;
    }
    currentUserData = doc.data();
    currentRole = currentUserData.rol;
    showAppForRole(currentRole);

    if (currentRole !== 'cobranzas' && currentRole !== 'fletero_cob') {
      startMovListener();
    }
    if (currentRole === 'admin') {
      startUsersListener();
      startAdminMovListener();
    }
    if (currentRole === 'logistica') {
      startRecorridasListener();
    }
    if (currentRole === 'cobranzas' || currentRole === 'fletero_cob') {
      startCobMovListener();
      if (currentRole === 'cobranzas') {
        startCobRecorridasListener();
        startCobProximasListener();
      }
    }
  });

  // picker color fletero
  function buildFleteroColorPicker(){
    const box = $('fleteroColorOptions');
    box.innerHTML = '';
    selectedFleteroColor = null;
    FLETERO_COLORS.forEach(col=>{
      const div = document.createElement('div');
      div.className = 'color-pill';
      div.style.background = col;
      div.onclick = ()=> {
        selectedFleteroColor = col;
        document.querySelectorAll('.color-pill').forEach(p=>p.classList.remove('selected'));
        div.classList.add('selected');
      };
      box.appendChild(div);
    });
  }

  function chooseFletero(){
    $('fleteroColorBox').style.display = 'block';
    buildFleteroColorPicker();
  }

  async function confirmFletero(){
    if (!selectedFleteroColor){
      alert("Elegí un color primero.");
      return;
    }
    await saveRole('fletero');
  }

  async function saveRole(rol){
    if(!currentUser) return;

    // admin fijo
    if (ADMIN_EMAILS.includes(currentUser.email)) {
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: 'admin',
        createdAt: new Date().toISOString()
      }, { merge: true });
      currentRole = 'admin';
      currentUserData = { email: currentUser.email, rol: 'admin' };
      showAppForRole('admin');
      startMovListener();
      startUsersListener();
      startAdminMovListener();
      return;
    }

    if (rol === 'fletero') {
      if (!selectedFleteroColor) {
        alert("Elegí un color para tu usuario de fletero.");
        return;
      }
      const taken = await db.collection(COL_USERS).where('color','==',selectedFleteroColor).get();
      if (!taken.empty) {
        alert("Ese color ya lo usa otro fletero. Elegí otro.");
        return;
      }
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: 'fletero',
        color: selectedFleteroColor,
        createdAt: new Date().toISOString()
      });
      currentRole = 'fletero';
      currentUserData = { email: currentUser.email, rol: 'fletero', color: selectedFleteroColor };
    } else {
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: rol,
        createdAt: new Date().toISOString()
      });
      currentRole = rol;
      currentUserData = { email: currentUser.email, rol: rol };
    }

    showAppForRole(currentRole);
    if (rol !== 'cobranzas' && rol !== 'fletero_cob') {
      startMovListener();
    }
    if (rol === 'logistica') startRecorridasListener();
    if (rol === 'cobranzas' || rol === 'fletero_cob') {
      startCobMovListener();
      if (rol === 'cobranzas') {
        startCobRecorridasListener();
        startCobProximasListener();
      }
    }
  }

  function showAppForRole(rol){
    $('rolePicker').style.display = 'none';
    $('app').style.display = 'block';
    $('userRole').textContent = 'Rol: ' + rol;

    document.body.className = '';
    if(rol === 'encargado')    document.body.classList.add('role-encargado');
    if(rol === 'preparado')    document.body.classList.add('role-preparado');
    if(rol === 'fletero')      document.body.classList.add('role-fletero');
    if(rol === 'admin')        document.body.classList.add('role-admin');
    if(rol === 'logistica')    document.body.classList.add('role-logistica');
    if(rol === 'cobranzas')    document.body.classList.add('role-cobranzas');
    if(rol === 'fletero_cob')  document.body.classList.add('role-fletero_cob');

    $('encargadoBox').style.display   = (rol === 'encargado' || rol === 'admin') ? 'block' : 'none';
    $('preparadoBox').style.display   = (rol === 'preparado') ? 'block' : 'none';
    $('fleteroBox').style.display     = (rol === 'fletero')   ? 'block' : 'none';
    $('adminBox').style.display       = (rol === 'admin')     ? 'block' : 'none';
    $('logisticaBox').style.display   = (rol === 'logistica') ? 'block' : 'none';
    $('cobranzasBox').style.display   = (rol === 'cobranzas') ? 'block' : 'none';
    $('fleteroCobBox').style.display  = (rol === 'fletero_cob') ? 'block' : 'none';

    // mostrar/ocultar tarjeta de movimientos de planta
    const movCard = $('movimientosCard');
    if (movCard){
      movCard.style.display =
        (rol === 'encargado' || rol === 'preparado' || rol === 'fletero' || rol === 'admin' || rol === 'logistica')
          ? 'block'
          : 'none';
    }
  }

  // CREAR MOVIMIENTO PLANTA (sin cantidad)
  $('btnCreate').onclick = async () => {
    if(currentRole !== 'encargado' && currentRole !== 'admin'){
      alert("Solo un encargado o el admin puede crear movimientos");
      return;
    }
    const mov = {
      creadoEn: new Date().toISOString(),
      encargado: $('encargado').value.trim(),
      origen: $('origen').value.trim(),
      destino: $('destino').value.trim(),
      descripcion: $('descripcion').value.trim(),
      prioridad: $('prioridad').value,
      tipoViaje: $('tipoViaje').value,
      obs: $('obs').value.trim(),
      estado: "Pendiente",
      fletero: null,
      fleteroUid: null,
      horarioEstimado: null,
      creadoPorUid: currentUser ? currentUser.uid : null
    };
    if(!mov.encargado || !mov.descripcion){
      alert("Completá al menos encargado y descripción");
      return;
    }
    try {
      await db.collection(COL_MOV).add(mov);
    } catch (e) {
      alert("No se pudo guardar en Firebase: " + e.message);
    }
    $('descripcion').value = '';
    $('obs').value = '';
  };

  // FILTROS PLANTA
  $('filter-todos').onclick = () => { setTypeFilter("todos"); startMovListener(); };
  $('filter-mp').onclick    = () => { setTypeFilter("Materia Prima"); startMovListener(); };
  $('filter-pt').onclick    = () => { setTypeFilter("Productos Terminados"); startMovListener(); };
  function setTypeFilter(val){
    currentTypeFilter = val;
    ['filter-todos','filter-mp','filter-pt'].forEach(id => $(id).classList.remove('filter-active'));
    if(val === 'todos') $('filter-todos').classList.add('filter-active');
    if(val === 'Materia Prima') $('filter-mp').classList.add('filter-active');
    if(val === 'Productos Terminados') $('filter-pt').classList.add('filter-active');
  }

  function getCurrentFleteroName() {
    const inp = $('fleteroNombre');
    if (inp && inp.value.trim()) return inp.value.trim();
    return currentUser ? currentUser.email : '';
  }

  // LISTENER MOVIMIENTOS PLANTA
  function startMovListener(){
    if (!currentUser || !currentRole) return;
    if (currentRole === 'cobranzas' || currentRole === 'fletero_cob') return; // no cargar para cobranzas
    if (unsubscribeMov) { unsubscribeMov(); unsubscribeMov = null; }

    unsubscribeMov = db.collection(COL_MOV)
      .orderBy("creadoEn","desc")
      .onSnapshot((snap)=>{
        const cont = $('movList');
        if (!cont) return;
        cont.innerHTML = '';
        let count = 0;
        let lastDateLabel = null;

        snap.forEach(doc=>{
          const d = doc.data();
          const created = new Date(d.creadoEn);

          if ((currentRole === 'preparado' || currentRole === 'fletero') && d.estado === 'Entregado') return;
          if (currentTypeFilter !== 'todos' && d.tipoViaje !== currentTypeFilter) return;

          count++;
          const dateStr = created.toLocaleDateString();
          if (lastDateLabel !== dateStr) {
            const title = document.createElement('div');
            title.textContent = dateStr;
            title.className = 'date-title';
            cont.appendChild(title);
            lastDateLabel = dateStr;
          }

          const div = document.createElement('div');
          div.className = 'movement';
          const estadoClass = 'estado-' + d.estado.replace(/ /g, '\\ ');

          if (currentRole === 'fletero' && currentUser && d.fleteroUid === currentUser.uid && currentUserData && currentUserData.color) {
            div.style.background = currentUserData.color + '22';
            div.style.borderColor = currentUserData.color;
          }

          const descLines = (d.descripcion || '').split(/\r?\n/).filter(l => l.trim() !== '');
          const descHTML = descLines.length
            ? descLines.map(l => `<div>► ${l}</div>`).join('')
            : '(sin descripción)';

          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
              <div>
                ${descHTML}
                <span class="badge ${estadoClass}" style="margin-top:4px;display:inline-block">${d.estado}</span>
              </div>
              <small>${created.toLocaleTimeString()}</small>
            </div>
            <div style="margin-top:4px">
              <small>Encargado:</small> ${d.encargado || '—'} |
              <small>Origen:</small> ${d.origen || '—'} →
              <small>Destino:</small> ${d.destino || '—'}
            </div>
            <div style="margin-top:4px">
              <small>Prioridad:</small> ${d.prioridad || '—'} |
              <small>Tipo:</small> ${d.tipoViaje || '—'} |
              <small>Fletero:</small> ${d.fletero || '—'}
            </div>
            ${d.horarioEstimado ? `<div style="margin-top:4px"><small>Horario estimado:</small> ${new Date(d.horarioEstimado).toLocaleString()}</div>` : ''}
            ${d.obs ? `<div style="margin-top:4px"><small>Obs:</small> ${d.obs}</div>` : ''}
            <div class="actions" id="actions-${doc.id}"></div>
          `;

          const actionsDiv = div.querySelector(`#actions-${doc.id}`);

          if (currentRole === 'preparado') {
            const btnListo = document.createElement('button');
            btnListo.className = 'ghost';
            btnListo.textContent = 'Listo para retirar';
            btnListo.onclick = () => setEstadoPreparado(doc.id);
            actionsDiv.appendChild(btnListo);

            const btnHorario = document.createElement('button');
            btnHorario.className = 'ghost';
            btnHorario.textContent = 'Hora';
            btnHorario.onclick = () => setHorarioEstimado(doc.id);
            actionsDiv.appendChild(btnHorario);

            const btnFaltante = document.createElement('button');
            btnFaltante.className = 'ghost';
            btnFaltante.style.color = '#b91c1c';
            btnFaltante.textContent = 'Reportar faltante';
            btnFaltante.onclick = () => reportarFaltante(doc.id, d);
            actionsDiv.appendChild(btnFaltante);
          }

          if (currentRole === 'fletero') {
            const btnTomar = document.createElement('button');
            btnTomar.className = 'ghost';
            btnTomar.textContent = 'Tomar';
            btnTomar.onclick = () => assignFletero(doc.id);
            actionsDiv.appendChild(btnTomar);

            const btnEnViaje = document.createElement('button');
            btnEnViaje.className = 'ghost';
            btnEnViaje.textContent = 'En viaje';
            btnEnViaje.onclick = () => setEstadoFletero(doc.id, d, 'En viaje');
            actionsDiv.appendChild(btnEnViaje);

            const btnEntregado = document.createElement('button');
            btnEntregado.className = 'ghost';
            btnEntregado.textContent = 'Entregado';
            btnEntregado.onclick = () => setEstadoFletero(doc.id, d, 'Entregado');
            actionsDiv.appendChild(btnEntregado);
          }

          if (currentRole === 'admin' && currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
            const x = document.createElement('button');
            x.textContent = '×';
            x.className = 'delete-x';
            x.onclick = () => deleteMov(doc.id);
            div.appendChild(x);
          }

          cont.appendChild(div);
        });
        const movCount = $('movCount');
        if (movCount){
          movCount.textContent = count ? `${count} movimientos` : 'No hay movimientos aún';
        }
      });
  }

  // ADMIN: LISTA COMPLETA DE MOVIMIENTOS (SOLO PLANTA)
  function startAdminMovListener(){
    if (unsubscribeAdminMov) { unsubscribeAdminMov(); unsubscribeAdminMov = null; }
    const box = $('adminMovList');
    unsubscribeAdminMov = db.collection(COL_MOV)
      .orderBy("creadoEn","desc")
      .onSnapshot(snap=>{
        box.innerHTML = '';
        snap.forEach(doc=>{
          const d = doc.data();
          const descLines = (d.descripcion || '').split(/\r?\n/).filter(l => l.trim() !== '');
          const descHTML = descLines.length
            ? descLines.map(l => `► ${l}`).join(' | ')
            : '(sin desc)';
          const div = document.createElement('div');
          div.className = 'admin-mov-item';
          div.innerHTML = `
            <strong>${descHTML}</strong> — ${d.estado} —
            <small>${new Date(d.creadoEn).toLocaleString()}</small><br>
            <small>Enc: ${d.encargado || '—'} | Tipo: ${d.tipoViaje || '—'} | Fletero: ${d.fletero || '—'}</small>
            ${d.faltanteOriginal ? `<div><small>Original:</small> ${d.faltanteOriginal}</div>` : ''}
          `;
          box.appendChild(div);
        });
      });
  }

  // LOGÍSTICA: escuchar recorridas
  function startRecorridasListener(){
    if (unsubscribeRecorridas) { unsubscribeRecorridas(); unsubscribeRecorridas = null; }
    unsubscribeRecorridas = db.collection(COL_RECORRIDAS)
      .orderBy("creadoEn","desc")
      .limit(20)
      .onSnapshot(snap=>{
        const box = $('log-historial');
        if (!box) return;
        box.innerHTML = '<h3 style="margin:6px 0 4px 0;font-size:13px">Últimas recorridas</h3>';
        snap.forEach(doc=>{
          const r = doc.data();
          const fecha = new Date(r.creadoEn).toLocaleString();
          const div = document.createElement('div');
          div.style.borderBottom = "1px solid #e5e7eb";
          div.style.padding = "6px 0";
          div.innerHTML = `
            <strong>${fecha}</strong>
            <small>Origen: ${r.origen}</small>
            <small>Paradas: ${(r.destinos && r.destinos.length) || 0}</small>
            ${r.googleLink ? `<small><a href="${r.googleLink}" target="_blank">Ver en Google Maps</a></small>` : ''}
          `;
          box.appendChild(div);
        });
      });
  }

  // COBRANZAS: escuchar movimientos (clientes)
  function startCobMovListener(){
    if (unsubscribeCobMov) { unsubscribeCobMov(); unsubscribeCobMov = null; }
    unsubscribeCobMov = db.collection(COL_COB_MOV)
      .orderBy("creadoEn","asc")  // más viejo arriba, más nuevo abajo
      .onSnapshot(snap=>{
        const boxCob = $('cob-mov-list');
        const boxFle = $('cob-mov-list-fletero');
        if (boxCob) boxCob.innerHTML = '';
        if (boxFle) boxFle.innerHTML = '';

        let lastDateCob = null;
        let lastDateFle = null;

        snap.forEach(doc=>{
          const d = doc.data();
          const id = doc.id;
          const created = new Date(d.creadoEn);
          const estado = d.estado || 'Pendiente';
          const dateStr = created.toLocaleDateString();

          // función para colorear por estado (pendiente rojo suave, retirado verde suave)
          function applyEstadoColor(divBase){
            if (estado === 'Pendiente'){
              divBase.style.background = '#fee2e2';
              divBase.style.borderColor = '#fecaca';
            } else if (estado === 'Retirado'){
              divBase.style.background = '#dcfce7';
              divBase.style.borderColor = '#bbf7d0';
            }
          }

          // Panel Cobranzas
          if (boxCob){
            if (lastDateCob !== dateStr){
              const title = document.createElement('div');
              title.textContent = dateStr;
              title.className = 'date-title';
              boxCob.appendChild(title);
              lastDateCob = dateStr;
            }
            const div = document.createElement('div');
            div.className = 'movement';
            applyEstadoColor(div);

            const retiroInfo = d.retiradoEn
              ? `<small>Retirado: ${new Date(d.retiradoEn).toLocaleTimeString()}</small><br>`
              : '';

            const edicionInfo = d.ultimaEdicion
              ? `<small>Última edición: ${new Date(d.ultimaEdicion.editadoEn).toLocaleString()} por ${d.ultimaEdicion.editadoPor}</small><br>
                 <small>Cambios: ${d.ultimaEdicion.cambios}</small><br>`
              : '';

            div.innerHTML = `
              <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
                <div>
                  <strong>${d.cliente || '—'}</strong>
                  <span class="badge" style="margin-left:4px">${estado}</span><br>
                  <small>${d.direccion || '—'}</small><br>
                  ${d.obs ? `<small>Obs: ${d.obs}</small><br>` : ''}
                  ${retiroInfo}
                  ${edicionInfo}
                </div>
                <div style="text-align:right">
                  <small>Registrado: ${created.toLocaleTimeString()}</small>
                </div>
              </div>
            `;

            if (currentRole === 'cobranzas'){
              const actions = document.createElement('div');
              actions.className = 'actions';
              const btnEdit = document.createElement('button');
              btnEdit.className = 'ghost';
              btnEdit.textContent = 'Editar';
              btnEdit.onclick = () => editarCobMovimiento(id, d);
              actions.appendChild(btnEdit);

              const btnDel = document.createElement('button');
              btnDel.className = 'ghost';
              btnDel.textContent = 'Eliminar';
              btnDel.onclick = () => deleteCobMovimiento(id);
              actions.appendChild(btnDel);

              div.appendChild(actions);
            }
            boxCob.appendChild(div);
          }

          // Panel Fletero de cobranzas
          if (boxFle){
            if (lastDateFle !== dateStr){
              const title2 = document.createElement('div');
              title2.textContent = dateStr;
              title2.className = 'date-title';
              boxFle.appendChild(title2);
              lastDateFle = dateStr;
            }
            const divF = document.createElement('div');
            divF.className = 'movement';
            applyEstadoColor(divF);

            const retiroInfoF = d.retiradoEn
              ? `<small>Retirado: ${new Date(d.retiradoEn).toLocaleTimeString()}</small><br>`
              : '';

            const edicionInfoF = d.ultimaEdicion
              ? `<small>Última edición: ${new Date(d.ultimaEdicion.editadoEn).toLocaleString()} por ${d.ultimaEdicion.editadoPor}</small><br>
                 <small>Cambios: ${d.ultimaEdicion.cambios}</small><br>`
              : '';

            divF.innerHTML = `
              <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
                <div>
                  <strong>${d.cliente || '—'}</strong>
                  <span class="badge" style="margin-left:4px">${estado}</span><br>
                  <small>${d.direccion || '—'}</small><br>
                  ${d.obs ? `<small>Obs: ${d.obs}</small><br>` : ''}
                  ${retiroInfoF}
                  ${edicionInfoF}
                </div>
                <div style="text-align:right">
                  <small>Registrado: ${created.toLocaleTimeString()}</small>
                </div>
              </div>
            `;
            const actionsF = document.createElement('div');
            actionsF.className = 'actions';

            if (currentRole === 'fletero_cob' && estado !== 'Retirado'){
              const btn = document.createElement('button');
              btn.className = 'ghost';
              btn.textContent = 'Retirado';
              btn.onclick = () => marcarRetiradoCob(id);
              actionsF.appendChild(btn);
            } else if (estado === 'Retirado' && d.retiradoPor){
              const info = document.createElement('small');
              info.textContent = `Retirado por ${d.retiradoPor} el ${new Date(d.retiradoEn).toLocaleString()}`;
              actionsF.appendChild(info);
            }
            divF.appendChild(actionsF);
            boxFle.appendChild(divF);
          }
        });
      });
  }

  // COBRANZAS: escuchar recorridas + eliminar
  function startCobRecorridasListener(){
    if (unsubscribeCobRec) { unsubscribeCobRec(); unsubscribeCobRec = null; }
    unsubscribeCobRec = db.collection(COL_COB_RECORRIDAS)
      .orderBy("creadoEn","desc")
      .limit(20)
      .onSnapshot(snap=>{
        const box = $('cob-historial');
        if (!box) return;
        box.innerHTML = '<h3 style="margin:6px 0 4px 0;font-size:13px">Últimas recorridas de cobranzas</h3>';
        snap.forEach(doc=>{
          const r = doc.data();
          const fecha = new Date(r.creadoEn).toLocaleString();
          const div = document.createElement('div');
          div.style.borderBottom = "1px solid #e5e7eb";
          div.style.padding = "6px 0";
          div.innerHTML = `
            <strong>${fecha}</strong><br>
            <small>Origen: ${r.origen || '—'}</small><br>
            <small>Paradas: ${(r.destinos && r.destinos.length) || 0}</small><br>
            ${r.googleLink ? `<small><a href="${r.googleLink}" target="_blank">Ver en Maps</a></small><br>` : ''}
          `;
          if (currentRole === 'cobranzas'){
            const btn = document.createElement('button');
            btn.className = 'ghost';
            btn.style.marginTop = "4px";
            btn.textContent = 'Eliminar recorrida';
            btn.onclick = () => deleteCobRecorrida(doc.id);
            div.appendChild(btn);
          }
          box.appendChild(div);
        });
      });
  }

  // COBRANZAS: escuchar próximas recorridas
  function startCobProximasListener(){
    if (unsubscribeCobProx) { unsubscribeCobProx(); unsubscribeCobProx = null; }
    unsubscribeCobProx = db.collection(COL_COB_PROX)
      .orderBy("fecha","asc")
      .onSnapshot(snap=>{
        const box = $('cob-prox-list');
        if (!box) return;
        box.innerHTML = '';
        snap.forEach(doc=>{
          const d = doc.data();
          const div = document.createElement('div');
          div.className = 'movement';
          div.style.background = '#f1f5f9';
          div.style.borderColor = '#e2e8f0';
          div.innerHTML = `
            <strong>${d.fecha || ''}</strong><br>
            <small>${d.detalle || ''}</small><br>
          `;
          if (currentRole === 'cobranzas'){
            const actions = document.createElement('div');
            actions.className = 'actions';
            const btn = document.createElement('button');
            btn.className = 'ghost';
            btn.textContent = 'Eliminar';
            btn.onclick = () => deleteCobProxima(doc.id);
            actions.appendChild(btn);
            div.appendChild(actions);
          }
          box.appendChild(div);
        });
      });
  }

  // ACCIONES MOVIMIENTOS PLANTA
  async function assignFletero(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    const finalName = getCurrentFleteroName();
    await db.collection(COL_MOV).doc(id).update({
      fletero: finalName,
      fleteroUid: currentUser.uid
    });
  }

  async function setEstadoFletero(id, movData, nuevoEstado){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if (!movData.fleteroUid) {
      alert("Primero tomá el movimiento.");
      return;
    }
    if (movData.fleteroUid !== currentUser.uid) {
      alert("Ese movimiento lo tiene otro fletero.");
      return;
    }
    const myName = getCurrentFleteroName();
    await db.collection(COL_MOV).doc(id).update({
      estado: nuevoEstado,
      fletero: myName,
      fleteroUid: currentUser.uid
    });
  }

  async function setEstadoPreparado(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    await db.collection(COL_MOV).doc(id).update({
      estado: "Listo para retirar"
    });
  }

  async function setHorarioEstimado(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    let hora = $('defaultHora') ? $('defaultHora').value : '';
    if(!hora){
      hora = prompt("Ingresá fecha y hora (formato 2025-11-06T15:30):",""); 
      if(!hora) return;
    }
    await db.collection(COL_MOV).doc(id).update({
      horarioEstimado: hora
    });
  }

  // Reportar faltante (sin editar el pedido original)
  async function reportarFaltante(id, movData){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    const originalDesc = movData.descripcion || "";
    const nota = prompt("Describí brevemente el faltante (opcional):","");

    await db.collection(COL_MOV).doc(id).update({
      estado: "Faltante",
      obs: nota ? nota : (movData.obs || ""),
      faltanteOriginal: originalDesc
    });
  }

  async function deleteMov(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if(!ADMIN_EMAILS.includes(currentUser.email)){
      alert("Solo el administrador puede eliminar movimientos");
      return;
    }
    if(!confirm("¿Eliminar este movimiento?")) return;
    await db.collection(COL_MOV).doc(id).delete();
  }

  // LISTA DE USUARIOS (SOLO ADMIN)
  function startUsersListener(){
    if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
    unsubscribeUsers = db.collection(COL_USERS)
      .orderBy("email","asc")
      .onSnapshot((snap)=>{
        const box = $('usersList');
        let html = '<table class="admin-table"><tr><th>Email</th><th>Rol</th><th>Color</th><th>Acción</th></tr>';
        snap.forEach(doc=>{
          const u = doc.data();
          html += `
          <tr>
              <td>${u.email || '—'}</td>
              <td>${u.rol || '—'}</td>
              <td>
              ${u.color 
                ? `<span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:${u.color};border:1px solid #ccc;"></span>` 
                : '—'}
              </td>
              <td><button class="ghost" onclick="deleteUser('${doc.id}')">Eliminar</button></td>
          </tr>
          `;
        });
        html += '</table>';
        box.innerHTML = html;
      });
  }

  async function deleteUser(uid){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if(!ADMIN_EMAILS.includes(currentUser.email)){
      alert("Solo el administrador puede eliminar usuarios");
      return;
    }
    if(!confirm("¿Eliminar este usuario del registro?")) return;
    await db.collection(COL_USERS).doc(uid).delete();
  }

  // ----------- LOGÍSTICA: generar link de Google Maps (sin API externa) -----------
  $('btnCalcularRecorrida').onclick = async () => {
    const origenTxt = $('log-origen').value.trim();
    const destinosTxt = $('log-destinos').value.trim();
    const out = $('log-result');
    out.innerHTML = "Generando link...";
    if(!origenTxt || !destinosTxt){
      out.innerHTML = "Completá origen y al menos una dirección.";
      return;
    }
    const destinosArr = destinosTxt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    if (destinosArr.length === 0){
      out.innerHTML = "Ingresá al menos una dirección.";
      return;
    }

    const originEnc = encodeURIComponent(origenTxt);
    const destFinal = encodeURIComponent(destinosArr[destinosArr.length-1]);
    let url = `https://www.google.com/maps/dir/?api=1&origin=${originEnc}&destination=${destFinal}&travelmode=driving`;

    if (destinosArr.length > 1){
      const waypoints = destinosArr.slice(0, -1).map(d => d.trim()).join('|');
      url += `&waypoints=${encodeURIComponent(waypoints)}`;
    }

    let html = `<strong>Recorrido (${destinosArr.length} paradas):</strong><ol>`;
    destinosArr.forEach(d => {
      html += `<li>${d}</li>`;
    });
    html += `</ol><a href="${url}" target="_blank">Abrir en Google Maps</a>`;
    out.innerHTML = html;

    await db.collection(COL_RECORRIDAS).add({
      creadoEn: new Date().toISOString(),
      origen: origenTxt,
      destinos: destinosArr,
      googleLink: url,
      creadoPor: currentUser ? currentUser.email : null
    });
  };

  // ----------- COBRANZAS: alta de cliente -----------
  $('btnCobAgregar').onclick = async () => {
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede cargar clientes de cobranza.");
      return;
    }
    const cliente = $('cob-cliente').value.trim();
    const direccion = $('cob-direccion').value.trim();
    const obs = $('cob-obs').value.trim();
    if (!cliente || !direccion){
      alert("Completá cliente y dirección.");
      return;
    }
    await db.collection(COL_COB_MOV).add({
      creadoEn: new Date().toISOString(),
      cliente,
      direccion,
      obs,
      estado: "Pendiente",
      creadoPor: currentUser ? currentUser.email : null
    });

    // actualizar textarea de direcciones (solo direcciones)
    const destArea = $('cob-destinos');
    if (destArea){
      const current = destArea.value.trim();
      destArea.value = current ? current + '\n' + direccion : direccion;
    }

    $('cob-cliente').value = '';
    $('cob-direccion').value = '';
    $('cob-obs').value = '';
  };

  // ----------- COBRANZAS: editar cliente -----------
  async function editarCobMovimiento(id, d){
    if (!currentUser){
      alert("Iniciá sesión");
      return;
    }
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede editar estos registros.");
      return;
    }

    const nombreEditor = prompt("Ingresá tu nombre para registrar la edición:");
    if (!nombreEditor) return;

    let nuevoCliente = prompt("Cliente", d.cliente || "") ;
    if (nuevoCliente === null) nuevoCliente = d.cliente || "";

    let nuevaDireccion = prompt("Dirección", d.direccion || "");
    if (nuevaDireccion === null) nuevaDireccion = d.direccion || "";

    let nuevaObs = prompt("Observaciones", d.obs || "");
    if (nuevaObs === null) nuevaObs = d.obs || "";

    const cambios = [];
    if (nuevoCliente !== (d.cliente || "")){
      cambios.push(`cliente: "${d.cliente || ''}" → "${nuevoCliente}"`);
    }
    if (nuevaDireccion !== (d.direccion || "")){
      cambios.push(`dirección: "${d.direccion || ''}" → "${nuevaDireccion}"`);
    }
    if (nuevaObs !== (d.obs || "")){
      cambios.push(`obs: "${d.obs || ''}" → "${nuevaObs}"`);
    }

    await db.collection(COL_COB_MOV).doc(id).update({
      cliente: nuevoCliente,
      direccion: nuevaDireccion,
      obs: nuevaObs,
      ultimaEdicion: {
        editadoPor: nombreEditor,
        editadoEn: new Date().toISOString(),
        cambios: cambios.length ? cambios.join(' | ') : 'Sin cambios en campos'
      }
    });
  }

  // ----------- COBRANZAS: eliminar cliente -----------
  async function deleteCobMovimiento(id){
    if (!currentUser){
      alert("Iniciá sesión");
      return;
    }
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede eliminar estos registros.");
      return;
    }
    if (!confirm("¿Eliminar este registro de cobranza?")) return;
    await db.collection(COL_COB_MOV).doc(id).delete();
  }

  // ----------- COBRANZAS: marcar retirado -----------
  async function marcarRetiradoCob(id){
    if (currentRole !== 'fletero_cob'){
      alert("Solo el Fletero de cobranzas puede marcar Retirado.");
      return;
    }
    await db.collection(COL_COB_MOV).doc(id).update({
      estado: "Retirado",
      retiradoPor: currentUser ? currentUser.email : null,
      retiradoEn: new Date().toISOString()
    });
  }

  // ----------- COBRANZAS: agregar próxima recorrida -----------
  $('btnCobAgregarProx').onclick = async () => {
    if (!currentUser){
      alert("Iniciá sesión");
      return;
    }
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede cargar próximas recorridas.");
      return;
    }
    const fecha = $('cob-prox-fecha').value;
    const detalle = $('cob-prox-detalle').value.trim();
    if (!fecha || !detalle){
      alert("Completá fecha y detalle.");
      return;
    }
    await db.collection(COL_COB_PROX).add({
      fecha,
      detalle,
      creadoEn: new Date().toISOString(),
      creadoPor: currentUser ? currentUser.email : null
    });
    $('cob-prox-fecha').value = '';
    $('cob-prox-detalle').value = '';
  };

  // ----------- COBRANZAS: eliminar próxima recorrida -----------
  async function deleteCobProxima(id){
    if (!currentUser){
      alert("Iniciá sesión");
      return;
    }
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede eliminar próximas recorridas.");
      return;
    }
    if (!confirm("¿Eliminar esta próxima recorrida?")) return;
    await db.collection(COL_COB_PROX).doc(id).delete();
  }

  // ----------- COBRANZAS: generar link de Maps ----------- 
  $('btnCobCalcularRecorrida').onclick = async () => {
    const origenTxt = $('cob-origen').value.trim();
    const destinosTxt = $('cob-destinos').value.trim();
    const out = $('cob-recorrida-result');
    out.innerHTML = "Generando link...";
    if(!origenTxt || !destinosTxt){
      out.innerHTML = "Completá origen y al menos una dirección.";
      return;
    }
    const destinosArr = destinosTxt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    if (destinosArr.length === 0){
      out.innerHTML = "Ingresá al menos una dirección.";
      return;
    }

    const originEnc = encodeURIComponent(origenTxt);
    const destFinal = encodeURIComponent(destinosArr[destinosArr.length-1]);
    let url = `https://www.google.com/maps/dir/?api=1&origin=${originEnc}&destination=${destFinal}&travelmode=driving`;

    if (destinosArr.length > 1){
      const waypoints = destinosArr.slice(0, -1).map(d => d.trim()).join('|');
      url += `&waypoints=${encodeURIComponent(waypoints)}`;
    }

    let html = `<strong>Recorrido cobranzas (${destinosArr.length} paradas):</strong><ol>`;
    destinosArr.forEach(d => {
      html += `<li>${d}</li>`;
    });
    html += `</ol><a href="${url}" target="_blank">Abrir en Google Maps</a>`;
    out.innerHTML = html;

    await db.collection(COL_COB_RECORRIDAS).add({
      creadoEn: new Date().toISOString(),
      origen: origenTxt,
      destinos: destinosArr,
      googleLink: url,
      creadoPor: currentUser ? currentUser.email : null
    });

    // limpiar direcciones para que no se mezclen con futuras recorridas
    $('cob-destinos').value = '';
  };

  // ----------- COBRANZAS: eliminar recorrida -----------
  async function deleteCobRecorrida(id){
    if (!currentUser){
      alert("Iniciá sesión");
      return;
    }
    if (currentRole !== 'cobranzas'){
      alert("Solo Cobranzas puede eliminar recorridas de cobranzas.");
      return;
    }
    if (!confirm("¿Eliminar esta recorrida de cobranzas?")) return;
    await db.collection(COL_COB_RECORRIDAS).doc(id).delete();
  }

  // Exponer funciones necesarias
  window.saveRole = saveRole;
  window.chooseFletero = chooseFletero;
  window.confirmFletero = confirmFletero;
  window.deleteUser = deleteUser;
  window.reportarFaltante = reportarFaltante;
  window.marcarRetiradoCob = marcarRetiradoCob;
  window.deleteCobRecorrida = deleteCobRecorrida;
  window.deleteCobMovimiento = deleteCobMovimiento;
  window.editarCobMovimiento = editarCobMovimiento;
  window.deleteCobProxima = deleteCobProxima;
</script>
</body>
</html>

