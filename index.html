<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Movimientos de Planta — Sistema Interno</title>
<style>
  :root {
    --bg: #edf2f7;
    --card: #ffffff;
    --text: #0f172a;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  body { margin:0; padding:16px; background:var(--bg); color:var(--text); transition:background .3s }
  header { background:linear-gradient(90deg,#2563eb,#1d4ed8); color:#fff; padding:14px 16px; border-radius:14px; max-width:1100px; margin:0 auto 8px }
  h1 { font-size:18px; margin:0 }
  .card { background:var(--card); padding:12px; border-radius:10px; box-shadow:0 1px 4px rgba(15,23,42,0.08); margin-top:12px }
  input,select,textarea { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:6px; background:#f8fafc }
  button { background:#2563eb; color:#fff; border:0; padding:8px 12px; border-radius:999px; font-weight:600; margin-top:8px; cursor:pointer }
  button.ghost { background:transparent; color:var(--text); border:1px solid #e2e8f0 }
  .row{display:flex;gap:8px;flex-wrap:wrap}.row .col{flex:1;min-width:150px}
  .movement{position:relative;padding:10px;border:1px solid #e6eef8;border-radius:8px;margin-bottom:8px;background:#fff}
  .delete-x{position:absolute;top:6px;right:6px;background:#dc2626;color:#fff;border:none;border-radius:999px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold}
  small{color:#6b7280}
  #app{display:none}#rolePicker{display:none}
  body.role-encargado{--bg:#e9f1ff}body.role-preparado{--bg:#e8f6ec}body.role-fletero{--bg:#fff1e8}body.role-admin{--bg:#e5e7eb}
  .admin-users{width:100%;border-collapse:collapse;margin-top:8px}
  .admin-users th,.admin-users td{border:1px solid #e2e8f0;padding:6px;font-size:13px}
  .admin-users th{background:#f1f5f9;text-align:left}
</style>
</head>
<body>
<header><h1>Movimientos de Planta — Sistema Interno</h1></header>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h2 style="margin-top:0;font-size:15px">Ingresar</h2>
  <label>Email <input id="loginEmail" type="text" placeholder="ejemplo@empresa.com"></label>
  <label>Contraseña <input id="loginPass" type="password" placeholder="******"></label>
  <button id="btnLogin">Ingresar</button>
  <button id="btnRegister" class="ghost">Crear cuenta</button>
</div>

<!-- ELEGIR ROL -->
<div class="card" id="rolePicker">
  <h2 style="margin-top:0;font-size:15px">Seleccioná tu rol</h2>
  <p>No encontramos tu rol en el sistema. Elegí uno:</p>
  <div class="row">
    <div class="col"><button onclick="saveRole('encargado')">Encargado</button></div>
    <div class="col"><button onclick="saveRole('preparado')">Preparado</button></div>
    <div class="col"><button onclick="saveRole('fletero')">Fletero</button></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px">
    <div><strong id="userInfo"></strong> <small id="userRole"></small></div>
    <button class="ghost" id="btnLogout">Salir</button>
  </div>

  <div id="encargadoBox" class="card">
    <h2 style="margin:0 0 6px 0;font-size:15px">Alta de movimiento (Encargado)</h2>
    <label>Encargado <input id="encargado" type="text"></label>
    <div class="row">
      <div class="col"><label>Origen <input id="origen" type="text"></label></div>
      <div class="col"><label>Destino <input id="destino" type="text"></label></div>
    </div>
    <label>Descripción <input id="descripcion" type="text"></label>
    <div class="row">
      <div class="col"><label>Cantidad <input id="cantidad" type="number" min="1" value="1"></label></div>
      <div class="col"><label>Prioridad 
        <select id="prioridad"><option>Media</option><option>Alta</option><option>Baja</option></select></label></div>
    </div>
    <label>Tipo de viaje 
      <select id="tipoViaje"><option>Materia Prima</option><option>Productos Terminados</option></select></label>
    <label>Observaciones <textarea id="obs" rows="2"></textarea></label>
    <button id="btnCreate">Crear movimiento</button>
  </div>

  <div id="preparadoBox" class="card" style="display:none">
    <h2>Panel de preparado</h2>
    <small>Marcá pedidos como “Listo para retirar” y podés agregar horario estimado.</small>
    <label>Horario estimado por defecto <input id="defaultHora" type="datetime-local"></label>
  </div>

  <div id="fleteroBox" class="card" style="display:none">
    <h2>Panel del fletero</h2>
    <label>Nombre fletero <input id="fleteroNombre" type="text"></label>
  </div>

  <div id="adminBox" class="card" style="display:none">
    <h2>Panel de administrador</h2>
    <small>Solo visible para gerencia@sagradamadre.com</small>
    <div id="usersList"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px 0;font-size:15px">Movimientos registrados</h2>
    <div id="movList"></div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script>
const ADMIN_EMAILS = ["gerencia@sagradamadre.com"];
const firebaseConfig = {
  apiKey: "AIzaSyDREgLXzhcblLmAD8ROhdin29TwGjCkH7Q",
  authDomain: "recorrida-planta.firebaseapp.com",
  projectId: "recorrida-planta",
  storageBucket: "recorrida-planta.firebasestorage.app",
  messagingSenderId: "528466299629",
  appId: "1:528466299629:web:e1ebe7fab15d030d6e5ae4",
  measurementId: "G-XPV4W80QZ2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(), auth = firebase.auth();
const $ = id=>document.getElementById(id);
let currentUser=null,currentRole=null,unsubscribeMov=null,unsubscribeUsers=null;

// login
$('btnLogin').onclick=async()=>{try{await auth.signInWithEmailAndPassword($('loginEmail').value,$('loginPass').value)}catch(e){alert(e.message)}}
$('btnRegister').onclick=async()=>{try{await auth.createUserWithEmailAndPassword($('loginEmail').value,$('loginPass').value)}catch(e){alert(e.message)}}
$('btnLogout').onclick=()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  currentUser=user;
  if(!user){$('loginBox').style.display='block';$('app').style.display='none';return}
  $('loginBox').style.display='none';$('userInfo').textContent=user.email;

  // si es admin por correo
  let forcedAdmin=false;
  if(ADMIN_EMAILS.includes(user.email)){
    await db.collection("usuarios").doc(user.uid).set({email:user.email,rol:"admin"},{merge:true});
    forcedAdmin=true;
  }
  const doc=await db.collection("usuarios").doc(user.uid).get();
  if(!doc.exists&&!forcedAdmin){$('rolePicker').style.display='block';return}
  currentRole=forcedAdmin?'admin':doc.data().rol;
  showAppForRole(currentRole);
  startMovListener();
  if(currentRole==='admin') startUsersListener();
});

async function saveRole(r){
  if(ADMIN_EMAILS.includes(currentUser.email)) r='admin';
  await db.collection("usuarios").doc(currentUser.uid).set({email:currentUser.email,rol:r});
  currentRole=r;showAppForRole(r);startMovListener();
}
function showAppForRole(r){
  $('rolePicker').style.display='none';$('app').style.display='block';
  $('userRole').textContent="Rol: "+r;
  $('encargadoBox').style.display=r==='encargado'?'block':'none';
  $('preparadoBox').style.display=r==='preparado'?'block':'none';
  $('fleteroBox').style.display=r==='fletero'?'block':'none';
  $('adminBox').style.display=r==='admin'?'block':'none';
}

// crear movimiento
$('btnCreate').onclick=async()=>{
  if(currentRole!=='encargado'&&currentRole!=='admin'){alert("Solo encargado o admin");return}
  const mov={encargado:$('encargado').value,origen:$('origen').value,destino:$('destino').value,
    descripcion:$('descripcion').value,cantidad:Number($('cantidad').value||0),prioridad:$('prioridad').value,
    tipoViaje:$('tipoViaje').value,obs:$('obs').value,estado:"Pendiente",creadoEn:new Date().toISOString(),fletero:null};
  await db.collection("movimientos").add(mov);
  $('descripcion').value='';$('obs').value='';
};

// listener movimientos
function startMovListener(){
  if(unsubscribeMov)unsubscribeMov();
  unsubscribeMov=db.collection("movimientos").orderBy("creadoEn","desc")
  .onSnapshot(snap=>{
    const cont=$('movList');cont.innerHTML='';snap.forEach(doc=>{
      const d=doc.data(); if((currentRole==='fletero'||currentRole==='preparado')&&d.estado==='Entregado')return;
      const div=document.createElement('div');div.className='movement';
      div.innerHTML=`<strong>${d.descripcion}</strong> — ${d.estado}<br><small>${d.encargado||''}</small>`;
      if(ADMIN_EMAILS.includes(currentUser.email)){
        const x=document.createElement('button');x.className='delete-x';x.textContent='×';
        x.onclick=()=>deleteMov(doc.id);div.appendChild(x);
      }
      cont.appendChild(div);
    });
  });
}

// eliminar movimiento (solo admin)
async function deleteMov(id){
  if(!ADMIN_EMAILS.includes(currentUser.email)){alert("Solo el administrador puede eliminar");return;}
  if(confirm("¿Eliminar este movimiento?")) await db.collection("movimientos").doc(id).delete();
}

// usuarios (solo admin)
function startUsersListener(){
  if(unsubscribeUsers)unsubscribeUsers();
  unsubscribeUsers=db.collection("usuarios").orderBy("email","asc").onSnapshot(snap=>{
    const box=$('usersList');
    let html='<table class="admin-users"><tr><th>Email</th><th>Rol</th><th>Acción</th></tr>';
    snap.forEach(doc=>{
      const u=doc.data();
      html+=`<tr><td>${u.email}</td><td>${u.rol}</td>
      <td><button class="ghost" onclick="deleteUser('${doc.id}')">Eliminar</button></td></tr>`;
    });
    html+='</table>';box.innerHTML=html;
  });
}
async function deleteUser(uid){
  if(!ADMIN_EMAILS.includes(currentUser.email)){alert("Solo el administrador puede eliminar usuarios");return;}
  if(confirm("¿Eliminar este usuario?")) await db.collection("usuarios").doc(uid).delete();
}
window.saveRole=saveRole;window.deleteUser=deleteUser;
</script>
</body>
</html>
