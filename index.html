<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAGRADA MADRE - Movimientos de Planta — Sistema interno</title>
  <style>
    :root{
      --bg: #edf2f7;
      --card: #ffffff;
      --primary: #2563eb;
      --text: #0f172a;
      --muted: #6b7280;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);transition:background .3s ease}
    header{background:linear-gradient(90deg,#2563eb,#1d4ed8);color:white;padding:14px 16px;border-radius:14px;max-width:1100px;margin:0 auto 8px}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(15,23,42,0.08);margin-top:12px}
    label{display:block;margin-top:8px;font-size:13px;color:#334155}
    input[type=text],input[type=password],input[type=datetime-local],input[type=number],select,textarea{
      width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:6px;background:#f8fafc
    }
    button{background:var(--primary);color:white;border:0;padding:8px 12px;border-radius:999px;font-weight:600;margin-top:10px;cursor:pointer}
    button.ghost{background:transparent;color:var(--text);border:1px solid #e2e8f0;border-radius:999px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row .col{flex:1;min-width:160px}
    .movement{position:relative;padding:10px;border:1px solid #e6eef8;border-radius:8px;margin-bottom:8px;background:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
    .estado-Pendiente{background:#fee4e2;color:#b42318}
    .estado-Listo\ para\ retirar{background:#fef9c3;color:#854d0e}
    .estado-En\ viaje{background:#eff8ff;color:#175cd3}
    .estado-Entregado{background:#ecfdf3;color:#027a48}
    .estado-Faltante{background:#fee2e2;color:#b91c1c}
    small{color:var(--muted)}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .delete-x{
      position:absolute;top:6px;right:6px;
      background:#f97316;color:white;border:none;border-radius:999px;
      width:26px;height:26px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:bold
    }
    .filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .filter-active{background:#0f172a;color:white;border-color:transparent}
    @media(min-width:900px){
      .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
      body{max-width:1100px;margin:0 auto;}
    }
    #app{display:none}
    #rolePicker{display:none}

    /* colores por rol */
    body.role-encargado { --primary:#0f766e; --bg:#e0f2f1; }
    body.role-preparado { --primary:#16a34a; --bg:#e8f6ec; }
    body.role-fletero   { --primary:#f97316; --bg:#fff1e8; }
    body.role-admin     { --primary:#0f172a; --bg:#e5e7eb; }
    body.role-logistica { --primary:#7c3aed; --bg:#ede9fe; }

    /* NUEVOS ROLES COBRANZAS */
    body.role-cobranzas    { --primary:#0ea5e9; --bg:#e0f2fe; }
    body.role-fletero_cob  { --primary:#fb7185; --bg:#ffe4e6; }

    body.role-preparado header{background:linear-gradient(90deg,#16a34a,#15803d);}
    body.role-fletero header{background:linear-gradient(90deg,#f97316,#ea580c);}
    body.role-admin header{background:linear-gradient(90deg,#0f172a,#1f2937);}
    body.role-logistica header{background:linear-gradient(90deg,#7c3aed,#6d28d9);}
    body.role-cobranzas header{background:linear-gradient(90deg,#0ea5e9,#0284c7);}
    body.role-fletero_cob header{background:linear-gradient(90deg,#fb7185,#e11d48);}

    .admin-table{width:100%;border-collapse:collapse;margin-top:6px}
    .admin-table th,.admin-table td{border:1px solid #e2e8f0;padding:6px;font-size:13px;text-align:left}
    .date-title{font-size:13px;font-weight:600;margin-top:10px;margin-bottom:4px;color:#0f172a}
    .admin-mov-list{max-height:260px;overflow-y:auto;margin-top:6px;border:1px solid #e2e8f0;border-radius:8px;padding:6px}
    .admin-mov-item{font-size:12px;border-bottom:1px solid #eef2f6;padding:4px 0}
    .admin-mov-item:last-child{border-bottom:0}

    /* picker de color fletero */
    #fleteroColorBox{margin-top:10px;display:none}
    .color-pill{
      width:28px;height:28px;border-radius:999px;border:2px solid transparent;cursor:pointer;display:inline-block;margin-right:6px;
    }
    .color-pill.selected{border-color:#0f172a}

    /* tabla recorridas */
    .recorridas-list small{display:block;margin-top:2px}

    /* COBRANZAS */
    .cob-list-item{
      border:1px solid #e2e8f0;
      border-radius:8px;
      padding:6px;
      margin-top:6px;
      font-size:13px;
      background:#fff;
    }
    .cob-badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:#fee2e2;
      color:#b91c1c;
    }
  </style>
</head>
<body>
<header>
  <h1>Movimientos de Planta — Sistema interno</h1>
</header>
<!-- GIF con fondo transparente -->
<div id="loginGifContainer"
     style="display:flex;justify-content:center;align-items:center;width:100%;margin-top:35px;margin-bottom:10px;">
  <img src="20-PM-unscreen.gif" alt="Camión animado" 
       style="width:280px;max-width:90%;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.1));">
</div>
  
<!-- LOGIN -->
<div class="card" id="loginBox">
  <h2 style="margin-top:0;font-size:15px">Ingresar</h2>
  <label>Correo
    <input id="loginEmail" type="text" placeholder="encargado@empresa.com" />
  </label>
  <label>Contraseña
    <input id="loginPass" type="password" placeholder="******" />
  </label>
  <button id="btnLogin">Ingresar</button>
  <button id="btnRegister" class="ghost">Crear cuenta</button>
  <small style="display:block;margin-top:6px">Encargados, Preparado, Fleteros, Logística y Admin se loguean acá.</small>
</div>

<!-- ELEGIR ROL / FLETERO COLOR -->
<div class="card" id="rolePicker">
  <h2 style="margin-top:0;font-size:15px">Seleccioná tu rol</h2>
  <p style="margin:0 0 6px 0">No encontramos tu rol en el sistema. Elegí uno:</p>
  <div class="row">
    <div class="col"><button onclick="saveRole('encargado')">Soy ENCARGADO</button></div>
    <div class="col"><button onclick="saveRole('preparado')">Soy PREPARADO</button></div>
    <div class="col"><button onclick="chooseFletero()">Soy FLETERO</button></div>
    <div class="col"><button onclick="saveRole('logistica')">Soy LOGÍSTICA</button></div>
    <div class="row" style="margin-top:10px">
    <div class="col"><button onclick="saveRole('cobranzas')">Soy COBRANZAS</button></div>
    <div class="col"><button onclick="saveRole('fletero_cob')">Soy FLETERO COB</button></div>
  </div>

  <div id="fleteroColorBox" style="display:none;margin-top:10px">
    <small>Elegí tu color (solo una vez):</small>
    <div id="fleteroColorOptions" style="margin-top:6px"></div>
    <button id="btnConfirmFletero" style="margin-top:10px" onclick="confirmFletero()">Aceptar fletero</button>
  </div>

  <small>Esto se guarda una sola vez.</small>
</div>

<!-- APP -->
<div id="app">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px">
    <div>
      <strong id="userInfo"></strong>
      <small id="userRole" style="margin-left:4px"></small>
    </div>
    <button class="ghost" id="btnLogout">Salir</button>
  </div>

  <div class="grid-2">
    <!-- ENCARGADO -->
    <div class="card" id="encargadoBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Alta de movimiento (Encargado)</h2>
      <label>Nombre del encargado
        <input id="encargado" type="text" placeholder="Ej: Juan Pérez" />
      </label>
      <div class="row">
        <div class="col">
          <label>Planta / Origen
            <input id="origen" type="text" placeholder="Ej: Planta 1" />
          </label>
        </div>
        <div class="col">
          <label>Destino
            <input id="destino" type="text" placeholder="Ej: Depósito central" />
          </label>
        </div>
      </div>
      <label>Producto / Descripción
        <textarea id="descripcion" rows="3" placeholder="Una cosa por línea. Ej:
20 cajas palo santo
5 cajas sahumerios
3 bolsas carbón"></textarea>
      </label>
      <div class="row">
        <div class="col">
          <label>Prioridad
            <select id="prioridad">
              <option value="Media">Media</option>
              <option value="Alta">Alta</option>
              <option value="Baja">Baja</option>
            </select>
          </label>
        </div>
      </div>
      <label>Tipo de viaje
        <select id="tipoViaje">
          <option value="Materia Prima">Materia Prima</option>
          <option value="Productos Terminados">Productos Terminados</option>
          <option value="Otro">Otro</option>
        </select>
      </label>
      <label>Observaciones
        <textarea id="obs" rows="2" placeholder="Algo a tener en cuenta..."></textarea>
      </label>
      <button id="btnCreate">Crear movimiento</button>
      <small style="display:block;margin-top:6px">Se crea con estado <strong>Pendiente</strong>.</small>
    </div>

    <!-- PREPARADO -->
    <div class="card" id="preparadoBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel de preparado</h2>
      <small>Marcás los pedidos como “Listo para retirar”, podés poner horario estimado o reportar faltante.</small>
      <label>Horario estimado por defecto
        <input id="defaultHora" type="datetime-local" />
      </label>
    </div>

    <!-- FLETERO -->
    <div class="card" id="fleteroBox">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel del fletero</h2>
      <label>Mi nombre (fletero)
        <input id="fleteroNombre" type="text" placeholder="Ej: Camión 3 - Luis" />
      </label>
      <small>Tomá el pedido y actualizá el estado.</small>
    </div>

    <!-- LOGÍSTICA -->
    <div class="card" id="logisticaBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Logística – armar recorrida</h2>
      <small>Ingresá la dirección de origen (planta, depósito, etc.) y abajo una dirección por línea.</small>
      <label>Origen
        <input id="log-origen" type="text" placeholder="Ej: Planta, Calle 123, Ciudad" />
      </label>
      <label>Direcciones a entregar (una por línea)
        <textarea id="log-destinos" rows="5" placeholder="Cliente 1, dirección...
Cliente 2, dirección...
Cliente 3, dirección..."></textarea>
      </label>
      <button id="btnCalcularRecorrida">Calcular recorrida</button>
      <div id="log-result" style="margin-top:10px;font-size:13px"></div>
      <div class="recorridas-list" id="log-historial" style="margin-top:12px"></div>
    </div>

    <!-- ADMIN -->
    <div class="card" id="adminBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Panel de administración</h2>
      <small>Solo gerencia@sagradamadre.com puede ver esto.</small>
      <div id="usersList"></div>
      <h3 style="margin-top:14px;font-size:13px">Registro completo de movimientos</h3>
      <small>Histórico (no se borra)</small>
      <div id="adminMovList" class="admin-mov-list"></div>
    </div>

    <!-- COBRANZAS -->
    <div class="card" id="cobranzasBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Cobranzas</h2>
      <small>Gestión de clientes y movimientos de cobranzas.</small>

      <h3 style="margin-top:10px;font-size:13px">Alta de cliente</h3>
      <label>Nombre del cliente
        <input id="cobClienteNombre" type="text" placeholder="Ej: Almacén La Esquina" />
      </label>
      <label>Dirección completa (para Maps)
        <input id="cobClienteDir" type="text" placeholder="Ej: Calle 123, Ciudad, Provincia" />
      </label>
      <label>Notas
        <textarea id="cobClienteNotas" rows="2" placeholder="Horario de cobro, referencias, etc."></textarea>
      </label>
      <button id="btnCobCrearCliente">Guardar cliente</button>

      <h3 style="margin-top:14px;font-size:13px">Nuevo movimiento de cobranza</h3>
      <label>Cliente
        <select id="cobClienteSelect">
          <option value="">Seleccionar cliente...</option>
        </select>
      </label>
      <label>Importe a cobrar
        <input id="cobImporte" type="number" min="0" step="0.01" placeholder="Ej: 150000" />
      </label>
      <label>Observaciones
        <textarea id="cobObs" rows="2" placeholder="Detalle del recibo, forma de pago esperada, etc."></textarea>
      </label>
      <button id="btnCobCrearMov">Crear movimiento de cobranza</button>

      <h3 style="margin-top:14px;font-size:13px">Clientes registrados</h3>
      <div id="cobClientesList"></div>

      <h3 style="margin-top:14px;font-size:13px">Movimientos de cobranza</h3>
      <div id="cobMovsList"></div>
    </div>

    <!-- FLETERO DE COBRANZAS -->
    <div class="card" id="fleteroCobBox" style="display:none">
      <h2 style="margin:0 0 6px 0;font-size:15px">Fletero de Cobranzas</h2>
      <small>Ver los movimientos y marcar como retirado.</small>
      <label>Mi nombre (fletero cobranzas)
        <input id="fleteroCobNombre" type="text" placeholder="Ej: Flete Cobranzas 1" />
      </label>
      <div id="fleteroCobMovsList" style="margin-top:10px"></div>
    </div>

  </div>

  <!-- LISTA -->
  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 6px 0;font-size:15px">Movimientos registrados</h2>
    <div class="filter-bar">
      <button class="ghost filter-active" id="filter-todos">Todos</button>
      <button class="ghost" id="filter-mp">Materia Prima</button>
      <button class="ghost" id="filter-pt">Productos Terminados</button>
    </div>
    <div id="movList"></div>
    <small id="movCount"></small>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script>
  // ← PONÉ TU API KEY VÁLIDA DE OPENROUTESERVICE ACA
  const ORS_KEY = "PONE_TU_API_KEY_DE_ORS_ACA";

  const ADMIN_EMAILS = ["gerencia@sagradamadre.com"];

  const firebaseConfig = {
    apiKey: "AIzaSyDREgLXzhcblLmAD8ROhdin29TwGjCkH7Q",
    authDomain: "recorrida-planta.firebaseapp.com",
    projectId: "recorrida-planta",
    storageBucket: "recorrida-planta.firebasestorage.app",
    messagingSenderId: "528466299629",
    appId: "1:528466299629:web:e1ebe7fab15d030d6e5ae4",
    measurementId: "G-XPV4W80QZ2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const $ = id => document.getElementById(id);
  const COL_MOV = "movimientos";
  const COL_USERS = "usuarios";
  const COL_RECORRIDAS = "recorridas";

  // NUEVAS COLECCIONES COBRANZAS
  const COL_COB_CLIENTES   = "cob_clientes";
  const COL_COB_RECORRIDAS = "cob_recorridas";
  const COL_COB_MOV        = "cob_mov";

  const FLETERO_COLORS = ["#f97316","#0ea5e9","#22c55e","#a855f7","#f43f5e","#eab308"];
  let selectedFleteroColor = null;

  let currentUser = null;
  let currentUserData = null;
  let currentRole = null;
  let currentTypeFilter = "todos";
  let unsubscribeMov = null;
  let unsubscribeUsers = null;
  let unsubscribeAdminMov = null;
  let unsubscribeRecorridas = null;
  // NUEVOS UNSUB COBRANZAS
  let unsubscribeCobClientes = null;
  let unsubscribeCobMovs = null;

  // LOGIN
  $('btnLogin').onclick = async () => {
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value.trim();
    if(!email || !pass){ alert("Completá email y contraseña"); return; }
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch(e){ alert("Error al ingresar: " + e.message); }
  };

  // REGISTRO
  $('btnRegister').onclick = async () => {
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value.trim();
    if(!email || !pass){ alert("Completá email y contraseña"); return; }
    try { await auth.createUserWithEmailAndPassword(email, pass); }
    catch(e){ alert("Error al crear usuario: " + e.message); }
  };

  $('btnLogout').onclick = () => auth.signOut();

  // SESIÓN
  auth.onAuthStateChanged(async (user)=>{
    currentUser = user;
    currentUserData = null;
    if(!user){
      document.body.className = '';
      $('loginBox').style.display = 'block';
      $('app').style.display = 'none';
      $('rolePicker').style.display = 'none';
      if (unsubscribeMov) { unsubscribeMov(); unsubscribeMov = null; }
      if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
      if (unsubscribeAdminMov) { unsubscribeAdminMov(); unsubscribeAdminMov = null; }
      if (unsubscribeRecorridas) { unsubscribeRecorridas(); unsubscribeRecorridas = null; }
      if (unsubscribeCobClientes) { unsubscribeCobClientes(); unsubscribeCobClientes = null; }
      if (unsubscribeCobMovs) { unsubscribeCobMovs(); unsubscribeCobMovs = null; }
      return;
    }
    $('loginBox').style.display = 'none';
    $('userInfo').textContent = user.email;

    if (ADMIN_EMAILS.includes(user.email)) {
      await db.collection(COL_USERS).doc(user.uid).set({
        email: user.email,
        rol: 'admin',
        createdAt: new Date().toISOString()
      }, { merge: true });
    }

    const ref = db.collection(COL_USERS).doc(user.uid);
    const doc = await ref.get();
    if(!doc.exists){
      $('rolePicker').style.display = 'block';
      $('app').style.display = 'none';
      return;
    }
    currentUserData = doc.data();
    currentRole = currentUserData.rol;
    showAppForRole(currentRole);
    startMovListener();
    if (currentRole === 'admin') {
      startUsersListener();
      startAdminMovListener();
    }
    if (currentRole === 'logistica') {
      startRecorridasListener();
    }
    if (currentRole === 'cobranzas' || currentRole === 'fletero_cob') {
      startCobClientesListener();
      startCobMovsListener();
    }
  });

  // construir picker de colores fletero
  function buildFleteroColorPicker(){
    const box = $('fleteroColorOptions');
    box.innerHTML = '';
    selectedFleteroColor = null;
    FLETERO_COLORS.forEach(col=>{
      const div = document.createElement('div');
      div.className = 'color-pill';
      div.style.background = col;
      div.onclick = ()=> {
        selectedFleteroColor = col;
        document.querySelectorAll('.color-pill').forEach(p=>p.classList.remove('selected'));
        div.classList.add('selected');
      };
      box.appendChild(div);
    });
  }

  function chooseFletero(){
    $('fleteroColorBox').style.display = 'block';
    buildFleteroColorPicker();
  }

  async function confirmFletero(){
    if (!selectedFleteroColor){
      alert("Elegí un color primero.");
      return;
    }
    await saveRole('fletero');
  }

  async function saveRole(rol){
    if(!currentUser) return;

    if (ADMIN_EMAILS.includes(currentUser.email)) {
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: 'admin',
        createdAt: new Date().toISOString()
      }, { merge: true });
      currentRole = 'admin';
      currentUserData = { email: currentUser.email, rol: 'admin' };
      showAppForRole('admin');
      startMovListener();
      startUsersListener();
      startAdminMovListener();
      return;
    }

    if (rol === 'fletero') {
      if (!selectedFleteroColor) {
        alert("Elegí un color para tu usuario de fletero.");
        return;
      }
      const taken = await db.collection(COL_USERS).where('color','==',selectedFleteroColor).get();
      if (!taken.empty) {
        alert("Ese color ya lo usa otro fletero. Elegí otro.");
        return;
      }
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: 'fletero',
        color: selectedFleteroColor,
        createdAt: new Date().toISOString()
      });
      currentRole = 'fletero';
      currentUserData = { email: currentUser.email, rol: 'fletero', color: selectedFleteroColor };
    } else {
      await db.collection(COL_USERS).doc(currentUser.uid).set({
        email: currentUser.email,
        rol: rol,
        createdAt: new Date().toISOString()
      });
      currentRole = rol;
      currentUserData = { email: currentUser.email, rol: rol };
    }

    showAppForRole(currentRole);
    startMovListener();
    if (rol === 'logistica') startRecorridasListener();
    if (rol === 'cobranzas' || rol === 'fletero_cob') {
      startCobClientesListener();
      startCobMovsListener();
    }
  }

  function showAppForRole(rol){
  // por las dudas, que nunca rompa si falta algún div
  if ($('rolePicker')) $('rolePicker').style.display = 'none';
  if ($('app'))        $('app').style.display        = 'block';
  if ($('userRole'))   $('userRole').textContent     = 'Rol: ' + rol;

  // clases de color por rol
  document.body.className = '';
  if (rol === 'encargado')    document.body.classList.add('role-encargado');
  if (rol === 'preparado')    document.body.classList.add('role-preparado');
  if (rol === 'fletero')      document.body.classList.add('role-fletero');
  if (rol === 'admin')        document.body.classList.add('role-admin');
  if (rol === 'logistica')    document.body.classList.add('role-logistica');
  if (rol === 'cobranzas')    document.body.classList.add('role-cobranzas');
  if (rol === 'fletero_cob')  document.body.classList.add('role-fletero_cob');

  // mostrar / ocultar módulos, sin romper si falta alguno
  safeShow('encargadoBox',  (rol === 'encargado' || rol === 'admin'));
  safeShow('preparadoBox',  (rol === 'preparado'));
  safeShow('fleteroBox',    (rol === 'fletero'));
  safeShow('adminBox',      (rol === 'admin'));
  safeShow('logisticaBox',  (rol === 'logistica'));

  // módulos nuevos
  safeShow('cobranzasBox',  (rol === 'cobranzas'));
  safeShow('fleteroCobBox', (rol === 'fletero_cob'));
}

  // CREAR MOVIMIENTO (sin cantidad)
  $('btnCreate').onclick = async () => {
    if(currentRole !== 'encargado' && currentRole !== 'admin'){
      alert("Solo un encargado o el admin puede crear movimientos");
      return;
    }
    const mov = {
      creadoEn: new Date().toISOString(),
      encargado: $('encargado').value.trim(),
      origen: $('origen').value.trim(),
      destino: $('destino').value.trim(),
      descripcion: $('descripcion').value.trim(),
      prioridad: $('prioridad').value,
      tipoViaje: $('tipoViaje').value,
      obs: $('obs').value.trim(),
      estado: "Pendiente",
      fletero: null,
      fleteroUid: null,
      horarioEstimado: null,
      creadoPorUid: currentUser ? currentUser.uid : null
    };
    if(!mov.encargado || !mov.descripcion){
      alert("Completá al menos encargado y descripción");
      return;
    }
    try {
      await db.collection(COL_MOV).add(mov);
    } catch (e) {
      alert("No se pudo guardar en Firebase: " + e.message);
    }
    $('descripcion').value = '';
    $('obs').value = '';
  };

  // FILTROS
  $('filter-todos').onclick = () => { setTypeFilter("todos"); startMovListener(); };
  $('filter-mp').onclick    = () => { setTypeFilter("Materia Prima"); startMovListener(); };
  $('filter-pt').onclick    = () => { setTypeFilter("Productos Terminados"); startMovListener(); };
  function setTypeFilter(val){
    currentTypeFilter = val;
    ['filter-todos','filter-mp','filter-pt'].forEach(id => $(id).classList.remove('filter-active'));
    if(val === 'todos') $('filter-todos').classList.add('filter-active');
    if(val === 'Materia Prima') $('filter-mp').classList.add('filter-active');
    if(val === 'Productos Terminados') $('filter-pt').classList.add('filter-active');
  }

  function getCurrentFleteroName() {
    const inp = $('fleteroNombre');
    if (inp && inp.value.trim()) return inp.value.trim();
    return currentUser ? currentUser.email : '';
  }

  // LISTENER MOVIMIENTOS
  function startMovListener(){
    if (!currentUser || !currentRole) return;
    if (unsubscribeMov) { unsubscribeMov(); unsubscribeMov = null; }

    unsubscribeMov = db.collection(COL_MOV)
      .orderBy("creadoEn","desc")
      .onSnapshot((snap)=>{
        const cont = $('movList');
        cont.innerHTML = '';
        let count = 0;
        let lastDateLabel = null;

        snap.forEach(doc=>{
          const d = doc.data();
          const created = new Date(d.creadoEn);

          if ((currentRole === 'preparado' || currentRole === 'fletero') && d.estado === 'Entregado') return;
          if (currentTypeFilter !== 'todos' && d.tipoViaje !== currentTypeFilter) return;

          count++;
          const dateStr = created.toLocaleDateString();
          if (lastDateLabel !== dateStr) {
            const title = document.createElement('div');
            title.textContent = dateStr;
            title.className = 'date-title';
            cont.appendChild(title);
            lastDateLabel = dateStr;
          }

          const div = document.createElement('div');
          div.className = 'movement';
          const estadoClass = 'estado-' + d.estado.replace(/ /g, '\\ ');

          if (currentRole === 'fletero' && currentUser && d.fleteroUid === currentUser.uid && currentUserData && currentUserData.color) {
            div.style.background = currentUserData.color + '22';
            div.style.borderColor = currentUserData.color;
          }

          const descLines = (d.descripcion || '').split(/\r?\n/).filter(l => l.trim() !== '');
          const descHTML = descLines.length
            ? descLines.map(l => `<div>► ${l}</div>`).join('')
            : '(sin descripción)';

          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
              <div>
                ${descHTML}
                <span class="badge ${estadoClass}" style="margin-top:4px;display:inline-block">${d.estado}</span>
              </div>
              <small>${created.toLocaleTimeString()}</small>
            </div>
            <div style="margin-top:4px">
              <small>Encargado:</small> ${d.encargado || '—'} |
              <small>Origen:</small> ${d.origen || '—'} →
              <small>Destino:</small> ${d.destino || '—'}
            </div>
            <div style="margin-top:4px">
              <small>Prioridad:</small> ${d.prioridad || '—'} |
              <small>Tipo:</small> ${d.tipoViaje || '—'} |
              <small>Fletero:</small> ${d.fletero || '—'}
            </div>
            ${d.horarioEstimado ? `<div style="margin-top:4px"><small>Horario estimado:</small> ${new Date(d.horarioEstimado).toLocaleString()}</div>` : ''}
            ${d.obs ? `<div style="margin-top:4px"><small>Obs:</small> ${d.obs}</div>` : ''}
            <div class="actions" id="actions-${doc.id}"></div>
          `;

          const actionsDiv = div.querySelector(`#actions-${doc.id}`);

          if (currentRole === 'preparado') {
            const btnListo = document.createElement('button');
            btnListo.className = 'ghost';
            btnListo.textContent = 'Listo para retirar';
            btnListo.onclick = () => setEstadoPreparado(doc.id);
            actionsDiv.appendChild(btnListo);

            const btnHorario = document.createElement('button');
            btnHorario.className = 'ghost';
            btnHorario.textContent = 'Hora';
            btnHorario.onclick = () => setHorarioEstimado(doc.id);
            actionsDiv.appendChild(btnHorario);

            const btnFaltante = document.createElement('button');
            btnFaltante.className = 'ghost';
            btnFaltante.style.color = '#b91c1c';
            btnFaltante.textContent = 'Reportar faltante';
            btnFaltante.onclick = () => reportarFaltante(doc.id, d);
            actionsDiv.appendChild(btnFaltante);
          }

          if (currentRole === 'fletero') {
            const btnTomar = document.createElement('button');
            btnTomar.className = 'ghost';
            btnTomar.textContent = 'Tomar';
            btnTomar.onclick = () => assignFletero(doc.id);
            actionsDiv.appendChild(btnTomar);

            const btnEnViaje = document.createElement('button');
            btnEnViaje.className = 'ghost';
            btnEnViaje.textContent = 'En viaje';
            btnEnViaje.onclick = () => setEstadoFletero(doc.id, d, 'En viaje');
            actionsDiv.appendChild(btnEnViaje);

            const btnEntregado = document.createElement('button');
            btnEntregado.className = 'ghost';
            btnEntregado.textContent = 'Entregado';
            btnEntregado.onclick = () => setEstadoFletero(doc.id, d, 'Entregado');
            actionsDiv.appendChild(btnEntregado);
          }

          if (currentRole === 'admin' && currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
            const x = document.createElement('button');
            x.textContent = '×';
            x.className = 'delete-x';
            x.onclick = () => deleteMov(doc.id);
            div.appendChild(x);
          }

          cont.appendChild(div);
        });
        $('movCount').textContent = count ? `${count} movimientos` : 'No hay movimientos aún';
      });
  }

  // ADMIN: LISTA COMPLETA DE MOVIMIENTOS
  function startAdminMovListener(){
    if (unsubscribeAdminMov) { unsubscribeAdminMov(); unsubscribeAdminMov = null; }
    const box = $('adminMovList');
    unsubscribeAdminMov = db.collection(COL_MOV)
      .orderBy("creadoEn","desc")
      .onSnapshot(snap=>{
        box.innerHTML = '';
        snap.forEach(doc=>{
          const d = doc.data();
          const descLines = (d.descripcion || '').split(/\r?\n/).filter(l => l.trim() !== '');
          const descHTML = descLines.length
            ? descLines.map(l => `► ${l}`).join(' | ')
            : '(sin desc)';
          const div = document.createElement('div');
          div.className = 'admin-mov-item';
          div.innerHTML = `
            <strong>${descHTML}</strong> — ${d.estado} —
            <small>${new Date(d.creadoEn).toLocaleString()}</small><br>
            <small>Enc: ${d.encargado || '—'} | Tipo: ${d.tipoViaje || '—'} | Fletero: ${d.fletero || '—'}</small>
            ${d.faltanteOriginal ? `<div><small>Original:</small> ${d.faltanteOriginal}</div>` : ''}
          `;
          box.appendChild(div);
        });
      });
  }

  // LOGÍSTICA: escuchar recorridas guardadas
  function startRecorridasListener(){
    if (unsubscribeRecorridas) { unsubscribeRecorridas(); unsubscribeRecorridas = null; }
    unsubscribeRecorridas = db.collection(COL_RECORRIDAS)
      .orderBy("creadoEn","desc")
      .limit(20)
      .onSnapshot(snap=>{
        const box = $('log-historial');
        box.innerHTML = '<h3 style="margin:6px 0 4px 0;font-size:13px">Últimas recorridas</h3>';
        snap.forEach(doc=>{
          const r = doc.data();
          const fecha = new Date(r.creadoEn).toLocaleString();
          const div = document.createElement('div');
          div.innerHTML = `
            <strong>${fecha}</strong>
            <small>Origen: ${r.origen}</small>
            <small>Paradas: ${r.stops.length}</small>
            ${r.googleLink ? `<small><a href="${r.googleLink}" target="_blank">Ver en Google Maps</a></small>` : ''}
          `;
          box.appendChild(div);
        });
      });
  }

  // ACCIONES MOVIMIENTOS
  async function assignFletero(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    const finalName = getCurrentFleteroName();
    await db.collection(COL_MOV).doc(id).update({
      fletero: finalName,
      fleteroUid: currentUser.uid
    });
  }

  async function setEstadoFletero(id, movData, nuevoEstado){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if (!movData.fleteroUid) {
      alert("Primero tomá el movimiento.");
      return;
    }
    if (movData.fleteroUid !== currentUser.uid) {
      alert("Ese movimiento lo tiene otro fletero.");
      return;
    }
    const myName = getCurrentFleteroName();
    await db.collection(COL_MOV).doc(id).update({
      estado: nuevoEstado,
      fletero: myName,
      fleteroUid: currentUser.uid
    });
  }

  async function setEstadoPreparado(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    await db.collection(COL_MOV).doc(id).update({
      estado: "Listo para retirar"
    });
  }

  async function setHorarioEstimado(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    let hora = $('defaultHora') ? $('defaultHora').value : '';
    if(!hora){
      hora = prompt("Ingresá fecha y hora (formato 2025-11-06T15:30):",""); 
      if(!hora) return;
    }
    await db.collection(COL_MOV).doc(id).update({
      horarioEstimado: hora
    });
  }

  async function reportarFaltante(id, movData){
    if(!currentUser){ alert("Iniciá sesión"); return; }

    const originalDesc = movData.descripcion || "";
    const nota = prompt("Describí brevemente el faltante (opcional):","");

    await db.collection(COL_MOV).doc(id).update({
      estado: "Faltante",
      obs: nota ? nota : (movData.obs || ""),
      faltanteOriginal: originalDesc
    });
  }

  async function deleteMov(id){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if(!ADMIN_EMAILS.includes(currentUser.email)){
      alert("Solo el administrador puede eliminar movimientos");
      return;
    }
    if(!confirm("¿Eliminar este movimiento?")) return;
    await db.collection(COL_MOV).doc(id).delete();
  }

  // LISTA DE USUARIOS (SOLO ADMIN)
  function startUsersListener(){
    if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
    unsubscribeUsers = db.collection(COL_USERS)
      .orderBy("email","asc")
      .onSnapshot((snap)=>{
        const box = $('usersList');
        let html = '<table class="admin-table"><tr><th>Email</th><th>Rol</th><th>Color</th><th>Acción</th></tr>';
        snap.forEach(doc=>{
          const u = doc.data();
          html += `
          <tr>
              <td>${u.email || '—'}</td>
              <td>${u.rol || '—'}</td>
              <td>
              ${u.color 
                ? `<span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:${u.color};border:1px solid #ccc;"></span>` 
                : '—'}
              </td>
              <td><button class="ghost" onclick="deleteUser('${doc.id}')">Eliminar</button></td>
          </tr>
          `;
        });
        html += '</table>';
        box.innerHTML = html;
      });
  }

  async function deleteUser(uid){
    if(!currentUser){ alert("Iniciá sesión"); return; }
    if(!ADMIN_EMAILS.includes(currentUser.email)){
      alert("Solo el administrador puede eliminar usuarios");
      return;
    }
    if(!confirm("¿Eliminar este usuario del registro?")) return;
    await db.collection(COL_USERS).doc(uid).delete();
  }

  // ----------- LOGÍSTICA: calcular recorrida con ORS -----------

  async function geocodeAddress(addr){
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${encodeURIComponent(ORS_KEY)}&text=${encodeURIComponent(addr)}&size=1`;
    const resp = await fetch(url);
    if(!resp.ok) throw new Error("No se pudo geocodificar: " + addr);
    const data = await resp.json();
    if(!data.features || !data.features.length) throw new Error("Dirección no encontrada: " + addr);
    const [lon, lat] = data.features[0].geometry.coordinates;
    return {lat, lon, label: addr};
  }

  async function distanceFromTo(origin, dest){
    // origin = {lat,lon}, dest = {lat,lon}
    const body = {
      coordinates: [
        [origin.lon, origin.lat],
        [dest.lon, dest.lat]
      ]
    };
    const resp = await fetch("https://api.openrouteservice.org/v2/directions/driving-car", {
      method: "POST",
      headers: {
        "Authorization": ORS_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if(!resp.ok) throw new Error("No se pudo obtener distancia");
    const data = await resp.json();
    const summary = data.features[0].properties.summary;
    return {
      meters: summary.distance,
      seconds: summary.duration
    };
  }

  // botón logística
  $('btnCalcularRecorrida').onclick = async () => {
    const origenTxt = $('log-origen').value.trim();
    const destinosTxt = $('log-destinos').value.trim();
    const out = $('log-result');
    out.innerHTML = "Calculando...";
    if(!origenTxt || !destinosTxt){
      out.innerHTML = "Completá origen y al menos una dirección.";
      return;
    }
    const destinosArr = destinosTxt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    try{
      const origenGeo = await geocodeAddress(origenTxt);

      // geocodifico todos los destinos en paralelo
      const geos = await Promise.all(destinosArr.map(d=>geocodeAddress(d)));

      // para cada destino obtengo distancia desde origen usando ORS
      const destinosConDist = [];
      for(let i=0;i<geos.length;i++){
        const dist = await distanceFromTo(origenGeo, geos[i]);
        destinosConDist.push({
          ...geos[i],
          original: destinosArr[i],
          distanceMeters: dist.meters,
          durationSecs: dist.seconds
        });
      }

      // ordeno por distancia ascendente
      destinosConDist.sort((a,b)=>a.distanceMeters - b.distanceMeters);

      // armo link de google maps
      const waypoints = destinosConDist.map(d=>`${d.lat},${d.lon}`).join('|');
      const last = destinosConDist[destinosConDist.length-1];
      const gmaps = `https://www.google.com/maps/dir/?api=1&origin=${origenGeo.lat},${origenGeo.lon}&destination=${last.lat},${last.lon}&waypoints=${encodeURIComponent(waypoints)}&travelmode=driving`;

      // muestro
      let html = `<strong>Recorrido sugerido (${destinosConDist.length} paradas):</strong><ol>`;
      destinosConDist.forEach((d,idx)=>{
        html += `<li>${d.original} — ${(d.distanceMeters/1000).toFixed(2)} km desde el origen</li>`;
      });
      html += `</ol><a href="${gmaps}" target="_blank">Abrir en Google Maps</a>`;
      out.innerHTML = html;

      // guardo en firestore
      await db.collection(COL_RECORRIDAS).add({
        creadoEn: new Date().toISOString(),
        origen: origenTxt,
        stops: destinosConDist.map(d=>({
          direccion: d.original,
          lat: d.lat,
          lon: d.lon,
          kmDesdeOrigen: +(d.distanceMeters/1000).toFixed(2)
        })),
        googleLink: gmaps,
        creadoPor: currentUser ? currentUser.email : null
      });

    }catch(e){
      console.error(e);
      out.innerHTML = "No se pudo calcular la recorrida: " + e.message;
    }
  };

  // ----------- COBRANZAS -----------

  function buildMapsLinkManual(dir){
    if (!dir) return '#';
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dir)}`;
  }

  function getCurrentFleteroCobName(){
    const inp = $('fleteroCobNombre');
    if (inp && inp.value.trim()) return inp.value.trim();
    return currentUser ? currentUser.email : '';
  }

  // Alta cliente cobranzas
  if ($('btnCobCrearCliente')) {
    $('btnCobCrearCliente').onclick = async () => {
      if (!currentUser) { alert("Iniciá sesión"); return; }
      const nombre = $('cobClienteNombre').value.trim();
      const dir    = $('cobClienteDir').value.trim();
      const notas  = $('cobClienteNotas').value.trim();
      if (!nombre || !dir) {
        alert("Completá al menos nombre y dirección del cliente.");
        return;
      }
      try{
        await db.collection(COL_COB_CLIENTES).add({
          nombre,
          direccion: dir,
          notas,
          creadoEn: new Date().toISOString(),
          creadoPor: currentUser.email || null
        });
        $('cobClienteNombre').value = '';
        $('cobClienteDir').value = '';
        $('cobClienteNotas').value = '';
      }catch(e){
        alert("No se pudo crear el cliente: " + e.message);
      }
    };
  }

  // Crear movimiento de cobranza
  if ($('btnCobCrearMov')) {
    $('btnCobCrearMov').onclick = async () => {
      if (!currentUser) { alert("Iniciá sesión"); return; }
      if (currentRole !== 'cobranzas') {
        alert("Solo el rol cobranzas puede crear movimientos de cobranza.");
        return;
      }
      const sel = $('cobClienteSelect');
      const clienteId = sel ? sel.value : '';
      const clienteNombre = sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : '';
      const importe = parseFloat($('cobImporte').value || '0');
      const obs = $('cobObs').value.trim();

      if (!clienteId) {
        alert("Elegí un cliente.");
        return;
      }
      if (!importe || importe <= 0) {
        alert("Ingresá un importe válido.");
        return;
      }

      // dirección se trae del option data-dir si está
      let direccion = '';
      if (sel && sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].dataset.dir) {
        direccion = sel.options[sel.selectedIndex].dataset.dir;
      }

      try{
        await db.collection(COL_COB_MOV).add({
          clienteId,
          clienteNombre,
          direccion,
          importe,
          obs,
          estado: "Pendiente",
          creadoEn: new Date().toISOString(),
          creadoPor: currentUser.email || null,
          retirado: false,
          retiradoPor: null,
          retiradoUid: null,
          retiradoEn: null
        });
        $('cobImporte').value = '';
        $('cobObs').value = '';
      }catch(e){
        alert("No se pudo crear el movimiento de cobranza: " + e.message);
      }
    };
  }

  function startCobClientesListener(){
    if (!currentUser) return;
    if (unsubscribeCobClientes) { unsubscribeCobClientes(); unsubscribeCobClientes = null; }

    unsubscribeCobClientes = db.collection(COL_COB_CLIENTES)
      .orderBy("nombre","asc")
      .onSnapshot(snap=>{
        const sel = $('cobClienteSelect');
        const list = $('cobClientesList');
        if (sel) {
          sel.innerHTML = '<option value="">Seleccionar cliente...</option>';
        }
        if (list) {
          list.innerHTML = '';
        }
        snap.forEach(doc=>{
          const c = doc.data();
          const optText = c.nombre || c.direccion || 'Cliente sin nombre';
          if (sel) {
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.textContent = optText;
            if (c.direccion) opt.dataset.dir = c.direccion;
            sel.appendChild(opt);
          }
          if (list) {
            const div = document.createElement('div');
            div.className = 'cob-list-item';
            div.innerHTML = `
              <strong>${c.nombre || 'Cliente sin nombre'}</strong><br>
              <small>Dirección:</small> ${c.direccion || '—'}<br>
              ${c.direccion ? `<a href="${buildMapsLinkManual(c.direccion)}" target="_blank">Ver en Maps</a>` : ''}
              ${c.notas ? `<div><small>Notas:</small> ${c.notas}</div>` : ''}
            `;
            list.appendChild(div);
          }
        });
      });
  }

  function startCobMovsListener(){
    if (!currentUser) return;
    if (unsubscribeCobMovs) { unsubscribeCobMovs(); unsubscribeCobMovs = null; }

    unsubscribeCobMovs = db.collection(COL_COB_MOV)
      .orderBy("creadoEn","desc")
      .onSnapshot(snap=>{
        const boxCob = $('cobMovsList');
        const boxFletero = $('fleteroCobMovsList');
        if (boxCob) boxCob.innerHTML = '';
        if (boxFletero) boxFletero.innerHTML = '';

        snap.forEach(doc=>{
          const m = doc.data();
          const fecha = m.creadoEn ? new Date(m.creadoEn).toLocaleString() : '';
          const baseHTML = `
            <div>
              <strong>${m.clienteNombre || 'Sin cliente'}</strong>
              <span class="cob-badge">${m.estado || 'Pendiente'}</span><br>
              <small>Importe:</small> $${m.importe ? m.importe.toLocaleString('es-AR') : '0'}<br>
              <small>Dirección:</small> ${m.direccion || '—'}<br>
              ${m.direccion ? `<a href="${buildMapsLinkManual(m.direccion)}" target="_blank">Ver en Maps</a><br>` : ''}
              <small>Creado:</small> ${fecha}
              ${m.retirado && m.retiradoPor ? `<br><small>Retirado por:</small> ${m.retiradoPor}` : ''}
            </div>
          `;

          if (boxCob) {
            const item = document.createElement('div');
            item.className = 'cob-list-item';
            item.innerHTML = baseHTML;
            boxCob.appendChild(item);
          }

          if (boxFletero) {
            // el fletero solo mira los que no están retirados
            if (m.estado === 'Retirado' || m.retirado) return;
            const item = document.createElement('div');
            item.className = 'cob-list-item';
            item.innerHTML = baseHTML;

            const actions = document.createElement('div');
            actions.className = 'actions';

            const btnRet = document.createElement('button');
            btnRet.className = 'ghost';
            btnRet.textContent = 'Retirado';
            btnRet.onclick = () => markCobMovRetirado(doc.id);
            actions.appendChild(btnRet);

            item.appendChild(actions);
            boxFletero.appendChild(item);
          }
        });
      });
  }

  async function markCobMovRetirado(id){
    if (!currentUser) { alert("Iniciá sesión"); return; }
    if (currentRole !== 'fletero_cob' && currentRole !== 'cobranzas') {
      alert("Solo fletero de cobranzas o cobranzas pueden marcar como retirado.");
      return;
    }
    const nombre = getCurrentFleteroCobName();
    try{
      await db.collection(COL_COB_MOV).doc(id).update({
        estado: "Retirado",
        retirado: true,
        retiradoPor: nombre,
        retiradoUid: currentUser.uid,
        retiradoEn: new Date().toISOString()
      });
    }catch(e){
      alert("No se pudo marcar como retirado: " + e.message);
    }
  }

  // exponer
  window.saveRole = saveRole;
  window.chooseFletero = chooseFletero;
  window.confirmFletero = confirmFletero;
  window.deleteUser = deleteUser;
  window.reportarFaltante = reportarFaltante;
</script>
</body>
</html>


