<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movimientos de Planta - Encargados y Fleteros</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;padding:16px;background:#f4f6f8;color:#0b1720}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(10,20,30,0.06);margin-top:12px}
    label{display:block;margin-top:8px;font-size:13px;color:#334155}
    input[type=text],input[type=number],select,textarea{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:6px}
    button{background:#0b74ff;color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;margin-top:10px;cursor:pointer}
    button.ghost{background:transparent;color:#0b1720;border:1px solid #e2e8f0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row .col{flex:1;min-width:160px}
    .movement{padding:10px;border:1px solid #e6eef8;border-radius:8px;margin-bottom:8px;background:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
    .estado-Pendiente{background:#fee4e2;color:#b42318}
    .estado-En\ viaje{background:#eff8ff;color:#175cd3}
    .estado-Entregado{background:#ecfdf3;color:#027a48}
    small{color:#6b7280}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    @media(min-width:900px){
      .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
      body{max-width:1100px;margin:0 auto;}
    }
  </style>
</head>
<body>
<header>
  <h1>Movimientos de Planta — Interno</h1>
  <small>Encargados crean → Fleteros actualizan</small>
</header>

<div class="grid-2">
  <!-- BLOQUE ENCARGADO -->
  <div class="card">
    <h2 style="margin:0 0 6px 0;font-size:15px">Alta de movimiento (Encargado)</h2>
    <label>Nombre del encargado
      <input id="encargado" type="text" placeholder="Ej: Juan Pérez" />
    </label>
    <div class="row">
      <div class="col">
        <label>Planta / Origen
          <input id="origen" type="text" placeholder="Ej: Planta 1" />
        </label>
      </div>
      <div class="col">
        <label>Destino
          <input id="destino" type="text" placeholder="Ej: Depósito central" />
        </label>
      </div>
    </div>
    <label>Producto / Descripción
      <input id="descripcion" type="text" placeholder="Ej: 20 cajas de repuestos" />
    </label>
    <div class="row">
      <div class="col">
        <label>Cantidad
          <input id="cantidad" type="number" min="1" value="1" />
        </label>
      </div>
      <div class="col">
        <label>Prioridad
          <select id="prioridad">
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
            <option value="Baja">Baja</option>
          </select>
        </label>
      </div>
    </div>
    <label>Observaciones
      <textarea id="obs" rows="2" placeholder="Algo a tener en cuenta para el fletero..."></textarea>
    </label>
    <button id="btnCreate">Crear movimiento</button>
    <small style="display:block;margin-top:6px">Se crea con estado <strong>Pendiente</strong>.</small>
  </div>

  <!-- BLOQUE FLETERO -->
  <div class="card">
    <h2 style="margin:0 0 6px 0;font-size:15px">Panel del fletero</h2>
    <label>Mi nombre (fletero)
      <input id="fleteroNombre" type="text" placeholder="Ej: Camión 3 - Luis" />
    </label>
    <small>Usaremos este nombre cuando toques “Tomar” o cambies estado.</small>
  </div>
</div>

<!-- LISTADO -->
<div class="card" style="margin-top:12px">
  <h2 style="margin:0 0 6px 0;font-size:15px">Movimientos registrados</h2>
  <div id="movList"></div>
  <small id="movCount"></small>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
  // tu config (la misma de antes)
  const firebaseConfig = {
    apiKey: "AIzaSyDREgLXzhcblLmAD8ROhdin29TwGjCkH7Q",
    authDomain: "recorrida-planta.firebaseapp.com",
    projectId: "recorrida-planta",
    storageBucket: "recorrida-planta.firebasestorage.app",
    messagingSenderId: "528466299629",
    appId: "1:528466299629:web:e1ebe7fab15d030d6e5ae4",
    measurementId: "G-XPV4W80QZ2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const COL = "movimientos";

  const $ = id => document.getElementById(id);

  // crear movimiento (encargado)
  $('btnCreate').onclick = async () => {
    const mov = {
      creadoEn: new Date().toISOString(),
      encargado: $('encargado').value.trim(),
      origen: $('origen').value.trim(),
      destino: $('destino').value.trim(),
      descripcion: $('descripcion').value.trim(),
      cantidad: Number($('cantidad').value || 0),
      prioridad: $('prioridad').value,
      obs: $('obs').value.trim(),
      estado: "Pendiente",
      fletero: null
    };
    // validación simple
    if(!mov.encargado || !mov.descripcion){
      alert("Completá al menos encargado y descripción/producto.");
      return;
    }
    await db.collection(COL).add(mov);
    // limpiar
    $('descripcion').value = '';
    $('cantidad').value = 1;
    $('obs').value = '';
  };

  // render listado en tiempo real
  db.collection(COL)
    .orderBy("estado", "asc")       // pendientes arriba
    .orderBy("creadoEn", "desc")
    .onSnapshot((snap)=>{
      const cont = $('movList');
      cont.innerHTML = '';
      let count = 0;
      snap.forEach(doc=>{
        count++;
        const d = doc.data();
        const div = document.createElement('div');
        div.className = 'movement';
        const estadoClass = 'estado-' + d.estado.replace(' ', '\\ ');
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
            <div>
              <strong>${d.descripcion || '(sin descripción)'} </strong>
              <span class="badge ${estadoClass}">${d.estado}</span>
            </div>
            <small>${new Date(d.creadoEn).toLocaleString()}</small>
          </div>
          <div style="margin-top:4px">
            <small>Encargado:</small> ${d.encargado || '—'} |
            <small>Origen:</small> ${d.origen || '—'} →
            <small>Destino:</small> ${d.destino || '—'}
          </div>
          <div style="margin-top:4px">
            <small>Cant:</small> ${d.cantidad || 0} |
            <small>Prioridad:</small> ${d.prioridad || '—'} |
            <small>Fletero:</small> ${d.fletero || '—'}
          </div>
          ${d.obs ? `<div style="margin-top:4px"><small>Obs:</small> ${d.obs}</div>` : ''}
          <div class="actions">
            <button class="ghost" onclick="assignFletero('${doc.id}')">Tomar</button>
            <button class="ghost" onclick="setEstado('${doc.id}', 'En viaje')">En viaje</button>
            <button class="ghost" onclick="setEstado('${doc.id}', 'Entregado')">Entregado</button>
            <button class="ghost" onclick="deleteMov('${doc.id}')">Eliminar</button>
          </div>
        `;
        cont.appendChild(div);
      });
      $('movCount').textContent = count ? `${count} movimientos` : 'No hay movimientos aún';
    });

  // funciones globales para los botones
  async function assignFletero(id){
    const nombre = $('fleteroNombre').value.trim();
    if(!nombre){
      alert("Poné tu nombre de fletero arriba primero.");
      return;
    }
    await db.collection(COL).doc(id).update({
      fletero: nombre
    });
  }
  async function setEstado(id, estado){
    const nombre = $('fleteroNombre').value.trim();
    // opcional: si no hay fletero asignado, se lo asignamos al que cambia estado
    const updateData = { estado };
    if(nombre) updateData.fletero = nombre;
    await db.collection(COL).doc(id).update(updateData);
  }
  async function deleteMov(id){
    if(confirm("¿Eliminar este movimiento?")){
      await db.collection(COL).doc(id).delete();
    }
  }
  // exponer
  window.assignFletero = assignFletero;
  window.setEstado = setEstado;
  window.deleteMov = deleteMov;
</script>
</body>
</html>

